# Redis å•çº¿ç¨‹å’Œé«˜æ€§èƒ½
é€šå¸¸è®² redis å•çº¿ç¨‹æŒ‡çš„æ˜¯ Redis çš„ç½‘ç»œ I/O å’ŒæŒ‡ä»¤è¯»å†™æ˜¯ç”±ä¸€ä¸ªçº¿ç¨‹å®Œæˆçš„ï¼Œè‡³äºå…¶ä»–çš„ä»»åŠ¡ï¼Œæ¯”å¦‚æŒä¹…åŒ–ã€æ•°æ®åŒæ­¥ç­‰å°±æ˜¯å¼‚æ­¥å®Œæˆçš„ï¼›

è™½ç„¶ç½‘ç»œ I/O å’ŒæŒ‡ä»¤è¯»å†™æ˜¯å•çº¿ç¨‹ï¼Œä½†æ˜¯ Redis æ˜¯åœ¨å†…å­˜ä¸­å·¥ä½œï¼Œå› æ­¤å³ä½¿æ˜¯å•çº¿ç¨‹ï¼Œæ‰§è¡Œæ•ˆç‡ä¹Ÿæ˜¯å¾ˆé«˜çš„ï¼›å…¶æ¬¡ï¼ŒRedis I/O æ¨¡å‹é‡‡ç”¨ epoll æ¥å®ç°
å¤šè·¯å¤ç”¨ï¼Œè¿™ä¹Ÿæ˜¯ Redis èƒ½å¤„ç†é‚£ä¹ˆå¤šå¹¶å‘å®¢æˆ·è¿æ¥çš„åŸå› ï¼›(I/O æ¨¡å‹è¯¦è§ NIO ç« èŠ‚[NIO](https://github.com/an-1024/Middleware_St/blob/master/nio/src/main/resources/note/1.NIOBIO.md))

# Redis æŒä¹…åŒ–
åˆšæ‰ä¹Ÿæåˆ°è¿‡ï¼ŒRedis æ˜¯å·¥ä½œåœ¨å†…å­˜ä¸­çš„ï¼Œæ‰€æœ‰çš„æ•°æ®ä¹Ÿåœ¨å†…å­˜ä¸­ã€‚æ‰€ä»¥ä¸€æ—¦æœåŠ¡å™¨å®•æœºï¼ŒRedis ç¼“å­˜çš„æ•°æ®å°±ä¼šå…¨éƒ¨ä¸¢å¤±ã€‚å› æ­¤ Redis é’ˆå¯¹äºè¿™ç§æƒ…å†µå®ç°
äº†ä¸¤ç§æŒä¹…åŒ–æœºåˆ¶ï¼šRDB(å¿«ç…§ï¼šå…¨é‡å¤‡ä»½)ã€AOF(å¢é‡å¤‡ä»½)ã€‚
## RDB å¿«ç…§
åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼ŒRedis å°†å†…å­˜æ•°æ®å¿«ç…§ä¿å­˜åœ¨åä¸º dump.rdb æ–‡ä»¶ä¸­ã€‚å¯ä»¥é€šè¿‡ä¿®æ”¹ redis.conf æ–‡ä»¶å‚æ•° `save` æ¥è®¾ç½®å¤šé•¿æ—¶é—´å†…ï¼Œä¿®æ”¹å¤šå°‘æ¬¡è¿›è¡Œä¸€æ¬¡
ä¿å­˜ã€‚å¦‚`save 60 1000`ï¼Œ60ç§’å†…è‡³å°‘æœ‰1000ä¸ªé”®è¢«ä¿®æ”¹ï¼Œå°±ä¼šè‡ªåŠ¨ä¿å­˜ä¸€æ¬¡ã€‚

1. æ•°æ®ä¸¢å¤±é—®é¢˜ï¼šè¿™ä¸ªä¿å­˜å¾ˆæ˜æ˜¾ä¼šæš´éœ²å‡ºä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯åœ¨è¾¾åˆ°è¿™ä¸ªè§¦å‘èŠ‚ç‚¹çš„æ—¶å€™ï¼ŒRedis å®•æœºï¼Œæ•°æ®å°±ä¼šä¸¢å¤±ã€‚
2. æ—¶ç‚¹æ€§é—®é¢˜ï¼šå†™å…¥æ•°æ®éœ€è¦æ—¶é—´ï¼Œæ¯”å¦‚ 8ç‚¹å¼€å§‹å†™å…¥æ•°æ®ï¼Œéœ€è¦4så†™å…¥ï¼Œé‚£ä¹ˆæœ€ç»ˆå­˜å…¥ç£ç›˜çš„æ•°æ®æ˜¯å“ªä¸€åˆ»çš„å‘¢ï¼Ÿ
3. æ•ˆç‡é—®é¢˜ï¼šåœ¨æœåŠ¡çº¿ä¸Šè¯·æ±‚çš„åŒæ—¶ï¼ŒRedis è¿˜éœ€è¦è¿›è¡Œå†…å­˜å¿«ç…§ï¼Œå†…å­˜å¿«ç…§è¦æ±‚ Redis å¿…é¡»è¿›è¡Œæ–‡ ä»¶ IO æ“ä½œï¼Œå¯æ–‡ä»¶ IO æ“ä½œæ˜¯ä¸èƒ½ä½¿ç”¨å¤šè·¯å¤ç”¨ APIã€‚

å…ˆæ¥è°ˆè°ˆ 2ã€3 é—®é¢˜ã€‚Redis ä¸ºäº†è§£å†³è¿™æ ·çš„é—®é¢˜ï¼Œé‡‡ç”¨æ“ä½œç³»ç»Ÿçš„å†™æ—¶å¤åˆ¶æŠ€æœ¯(Copy-On-Write,COW)ï¼Œå°±æ˜¯ä»çˆ¶è¿›ç¨‹ä¸­ fork ä¸€ä¸ªå­è¿›ç¨‹ï¼Œå­è¿›ç¨‹å®Œå…¨å¯ä»¥å…±äº«
çˆ¶è¿›ç¨‹çš„æ•°æ®ï¼Œå¦‚æœçˆ¶è¿›ç¨‹æ˜¯å¯¹æ•°æ®è¿›è¡Œè¯»æ“ä½œï¼Œå¯¹äºå­è¿›ç¨‹æ²¡æœ‰å½±å“ï¼Œç›´æ¥å‘ç£ç›˜å†™å…¥æ•°æ®ã€‚å¦‚æœæ˜¯å†™æ“ä½œï¼Œé‚£ä¹ˆçˆ¶è¿›ç¨‹ä¼šå°†é‚£ä¸€åˆ»çš„æ•°æ®å¤åˆ¶å‡ºä¸€ä»½å‡ºæ¥ï¼Œç„¶ååœ¨æ–°çš„
æ•°æ®ä¸Šè¿›è¡Œä¿®æ”¹ï¼Œè€Œå­è¿›ç¨‹å†™å…¥çš„æ•°æ®è¿˜æ˜¯æ“ä½œæ•°æ®ä¹‹å‰é‚£ä¸€åˆ»çš„æ•°æ®ã€‚å› æ­¤é—®é¢˜ 2 ä¸­å†™å…¥çš„æ•°æ®æ˜¯ fork å­è¿›ç¨‹é‚£ä¸€åˆ»çš„ã€‚

## AOF(å¢é‡å¤‡ä»½)
AOF å°±æ˜¯ä¸ºäº†è§£å†³ RDB æ•°æ®ä¸¢å¤±çš„é—®é¢˜ã€‚AOF ä¼šå°†ä¿®æ”¹çš„æ¯ä¸€æ¡æŒ‡ä»¤è®°å½•è¿›æ–‡ä»¶appendonly.aofä¸­(å…ˆå†™å…¥os cacheï¼Œæ¯éš”ä¸€æ®µæ—¶é—´ fsyncåˆ°ç£ç›˜)ã€‚å¯ä»¥
é€šè¿‡å‚æ•°`# appendonly yes` è¿›è¡Œæ§åˆ¶ã€‚æ‰“å¼€è¿™ä¸ªæœºåˆ¶åï¼Œæ¯å½“ redis ä¿®æ”¹ä¸€ä¸ªæ•°æ®é›†ï¼Œè¿™ä¸ªå‘½ä»¤å°±ä¼šè¢«è¿½åŠ åˆ°è¿™ä¸ªæ–‡ä»¶çš„æœ«å°¾ã€‚è¿™æ ·å³ä½¿ redis å®•æœºï¼Œ
ä¹Ÿå¯ä»¥é€šè¿‡ aof æ–‡ä»¶è¿›è¡Œæ•°æ®æ¢å¤ã€‚åŒæ · redis ä¹Ÿæä¾›äº†é…ç½®ç­–ç•¥ï¼š
```shell
appendfsync always # æ¯æ¬¡æœ‰æ–°å‘½ä»¤è¿½åŠ åˆ° AOF æ–‡ä»¶æ—¶å°±æ‰§è¡Œä¸€æ¬¡ fsync ï¼Œéå¸¸æ…¢ï¼Œä¹Ÿéå¸¸å®‰å…¨ã€‚
appendfsync everysec # æ¯ç§’ fsync ä¸€æ¬¡ï¼Œè¶³å¤Ÿå¿«ï¼Œå¹¶ä¸”åœ¨æ•…éšœæ—¶åªä¼šä¸¢å¤± 1 ç§’é’Ÿçš„æ•°æ®ã€‚
appendfsync no # ä»ä¸ fsync ï¼Œå°†æ•°æ®äº¤ç»™æ“ä½œç³»ç»Ÿæ¥å¤„ç†ã€‚æ›´å¿«ï¼Œä¹Ÿæ›´ä¸å®‰å…¨çš„é€‰æ‹©ã€‚
```

## fsync 
Linux çš„ glibc æä¾›äº† fsync(int fd)å‡½æ•°å¯ä»¥å°†æŒ‡å®šæ–‡ä»¶çš„å†…å®¹å¼ºåˆ¶ä»å†…æ ¸ç¼“å­˜åˆ·åˆ°ç£ ç›˜ã€‚åªè¦ Redis è¿›ç¨‹å®æ—¶è°ƒç”¨ fsync å‡½æ•°å°±å¯ä»¥ä¿è¯ aof 
æ—¥å¿—ä¸ä¸¢å¤±ã€‚ä½†æ˜¯ fsync æ˜¯ä¸€ä¸ª ç£ç›˜ IO æ“ä½œï¼Œå®ƒå¾ˆæ…¢!å¦‚æœ Redis æ‰§è¡Œä¸€æ¡æŒ‡ä»¤å°±è¦ fsync ä¸€æ¬¡ï¼Œé‚£ä¹ˆ Redis é«˜æ€§èƒ½çš„ åœ°ä½å°±ä¸ä¿äº†ã€‚ æ‰€ä»¥åœ¨
ç”Ÿäº§ç¯å¢ƒçš„æœåŠ¡å™¨ä¸­ï¼ŒRedis é€šå¸¸æ˜¯æ¯éš” 1s å·¦å³æ‰§è¡Œä¸€æ¬¡ fsync æ“ä½œï¼Œå‘¨æœŸ 1s æ˜¯å¯ä»¥é…ç½®çš„ã€‚è¿™æ˜¯åœ¨æ•°æ®å®‰å…¨æ€§å’Œæ€§èƒ½ä¹‹é—´åšäº†ä¸€ä¸ªæŠ˜ä¸­ï¼Œåœ¨ä¿æŒ
é«˜æ€§èƒ½çš„åŒæ—¶ï¼Œå°½å¯èƒ½ ä½¿å¾—æ•°æ®å°‘ä¸¢å¤±ã€‚

redis åœ¨ä¸šåŠ¡é•¿æœŸè¿è¡ŒæœŸé—´ï¼ŒAOFçš„æ—¥å¿—è‚¯å®šä¼šå˜å¾—å¾ˆé•¿å¾ˆé•¿ğŸ¤®ã€‚å¦‚æœå®ä¾‹å®•æœºï¼Œé‚£ä¹ˆä½¿ç”¨ AOF æ¢å¤çš„æ—¶å€™ï¼Œä¼šå¯¼è‡´ Redis é•¿æ—¶é—´æ— æ³•å¯¹å¤–æä¾›æœåŠ¡ï¼Œè¿™æ˜¾ç„¶
æ˜¯ä¸èƒ½å®¹å¿çš„ã€‚æ‰€ä»¥éœ€è¦å¯¹ AOF è¿›è¡Œç˜¦èº«ã€‚

### AOF æ—¥å¿—ç˜¦èº«
Redis æä¾›äº† bgrewriteaof æŒ‡ä»¤ç”¨äºå¯¹ AOF æ—¥å¿—è¿›è¡Œç˜¦èº«ã€‚å…¶åŸç†å°±æ˜¯å¼€è¾Ÿä¸€ä¸ªå­è¿›ç¨‹å¯¹å†…å­˜è¿›è¡Œéå†è½¬æ¢æˆä¸€ç³»åˆ— Redis çš„æ“ä½œæŒ‡ä»¤ï¼Œ
åºåˆ—åŒ–åˆ°ä¸€ä¸ªæ–°çš„ AOF æ—¥å¿—æ–‡ä»¶ä¸­ã€‚åšæ³•å°±æ˜¯å»æ‰ç›¸åŒé”®å€¼æ— ç”¨çš„æŒ‡ä»¤ï¼Œåªä¿æŒå¯¹è¯¥ key æ“ä½œçš„æœ€æ–°æŒ‡ä»¤ã€‚

## å°ç»“
1. å¿«ç…§ï¼šå¿«ç…§æ˜¯é€šè¿‡å¼€å¯å­è¿›ç¨‹çš„æ–¹å¼è¿›è¡Œçš„ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ¯”è¾ƒè€—èµ„æºçš„æ“ä½œï¼Œéå†æ•´ä¸ªå†…å­˜ï¼Œå¤§å—å†™ç£ç›˜ä¼šåŠ é‡ç³»ç»Ÿè´Ÿè½½ï¼›
2. AOFï¼šfsync æ˜¯ä¸€ä¸ªè€—æ—¶çš„ IO æ“ä½œï¼Œå®ƒä¼šé™ä½ Redis æ€§èƒ½ï¼ŒåŒæ—¶ä¹Ÿä¼šå¢åŠ ç³»ç»Ÿ IO è´Ÿæ‹…ï¼›

æ‰€ä»¥é€šå¸¸ Redis çš„ä¸»èŠ‚ç‚¹æ˜¯ä¸ä¼šè¿›è¡ŒæŒä¹…åŒ–æ“ä½œï¼ŒæŒä¹…åŒ–æ“ä½œä¸»è¦åœ¨ä»èŠ‚ç‚¹è¿›è¡Œã€‚ä»èŠ‚ ç‚¹æ˜¯å¤‡ä»½èŠ‚ç‚¹ï¼Œæ²¡æœ‰æ¥è‡ªå®¢æˆ·ç«¯è¯·æ±‚çš„å‹åŠ›ï¼Œå®ƒçš„æ“ä½œç³»ç»Ÿèµ„æº
å¾€å¾€æ¯”è¾ƒå……æ²›ã€‚

## Redis 4.0 æ··åˆæŒä¹…åŒ–
ä¸Šé¢æåˆ°è¿‡ï¼ŒRDB å®¹æ˜“ä¸¢å¤±å¤§é‡æ•°æ®ï¼Œä¸€èˆ¬ä½¿ç”¨ aof æ¢å¤ï¼Œä½†æ˜¯ aof æ¢å¤æ•°æ®ç›¸æ¯”äº rdb æ¥è¯´è¦æ…¢å¾ˆå¤šï¼Œåœ¨ redis å®ä¾‹è¾ƒå¤§çš„æƒ…å†µä¸‹ï¼Œå¯åŠ¨å¾ˆæ…¢ã€‚ä¸ºäº†
è§£å†³è¿™æ ·çš„é—®é¢˜ï¼ŒRedis 4.0 å¸¦æ¥äº†ä¸€ä¸ªæ–°çš„æŒä¹…åŒ–é€‰é¡¹â€”â€”æ··åˆæŒä¹…åŒ–ã€‚å°† RDB æ–‡ä»¶å’Œå¢é‡çš„ aof æ—¥å¿—æ–‡ä»¶æ”¾åˆ°ä¸€èµ·ã€‚æ³¨æ„è¿™é‡Œçš„ aof æ—¥å¿—ä¸å†æ˜¯å…¨é‡çš„
æ—¥å¿—äº†ï¼Œè€Œæ˜¯è‡ªæŒä¹…åŒ–å¼€å§‹åˆ°æŒä¹…åŒ–ç»“æŸè¿™ä¸€æ®µæ—¶é—´æ—¥å¿—çš„å¢é‡ã€‚

## Redis æ•°æ®å¤‡ä»½ç­–ç•¥
1. å†™crontabå®šæ—¶è°ƒåº¦è„šæœ¬ï¼Œæ¯å°æ—¶éƒ½copyä¸€ä»½rdbæˆ–aofçš„å¤‡ä»½åˆ°ä¸€ä¸ªç›®å½•ä¸­å»ï¼Œä»…ä»…ä¿ç•™æœ€è¿‘48 å°æ—¶çš„å¤‡ä»½
2. æ¯å¤©éƒ½ä¿ç•™ä¸€ä»½å½“æ—¥çš„æ•°æ®å¤‡ä»½åˆ°ä¸€ä¸ªç›®å½•ä¸­å»ï¼Œå¯ä»¥ä¿ç•™æœ€è¿‘1ä¸ªæœˆçš„å¤‡ä»½
3. æ¯æ¬¡copyå¤‡ä»½çš„æ—¶å€™ï¼Œéƒ½æŠŠå¤ªæ—§çš„å¤‡ä»½ç»™åˆ äº†
4. æ¯å¤©æ™šä¸Šå°†å½“å‰æœºå™¨ä¸Šçš„å¤‡ä»½å¤åˆ¶ä¸€ä»½åˆ°å…¶ä»–æœºå™¨ä¸Šï¼Œä»¥é˜²æœºå™¨æŸå

# Redis ä¸»ä»æ¶æ„
## ä¸»ä»é…ç½®
ä¸»èŠ‚ç‚¹é…ç½®ä¿¡æ¯å¦‚ä¸‹ï¼š
```text
# æŒ‡å®šæœ¬æœºé€šè¿‡æœ¬æœºçš„å“ªä¸€ä¸ª ip åœ°å€æ¥æ¥æ”¶å¤–éƒ¨è¯·æ±‚ï¼Œè€Œä¸æ˜¯å…è®¸é‚£ä¸ª ip è®¿é—®
bind 0.0.0.0
# å…³é—­ä¿æŠ¤æ¨¡å¼
protected-mode no
# è®¾ç½® port ç«¯å£
port 6379
# è®¾ç½®åå°è¿è¡Œ
daemonize yes
# ä¿å­˜ redis è¿è¡Œçš„ pid, è¿›ç¨‹ç»“æŸåä¼šè‡ªåŠ¨åˆ é™¤
pidfile /var/run/redis_6379.pid
# ç”Ÿæˆæ—¥å¿—æ–‡ä»¶åç§°
logfile "redis_6379.log"
# æŒ‡å®šç”Ÿæˆå¤‡ä»½æ•°æ®çš„æ–‡ä»¶ç›®å½•
dir /root/Dev_Azh/redis/data/6379
```
ä»èŠ‚ç‚¹é…ç½®å¦‚ä¸‹ï¼š
```text
# æŒ‡å®šæœ¬æœºé€šè¿‡æœ¬æœºçš„å“ªä¸€ä¸ª ip åœ°å€æ¥æ¥æ”¶å¤–éƒ¨è¯·æ±‚ï¼Œè€Œä¸æ˜¯å…è®¸é‚£ä¸ª ip è®¿é—®
bind 0.0.0.0
# å…³é—­ä¿æŠ¤æ¨¡å¼
protected-mode no
# è®¾ç½® port ç«¯å£
port 6380
# è®¾ç½®åå°è¿è¡Œ
daemonize yes
# ä¿å­˜ redis è¿è¡Œçš„ pid, è¿›ç¨‹ç»“æŸåä¼šè‡ªåŠ¨åˆ é™¤
pidfile /var/run/redis_6380.pid
# ç”Ÿæˆæ—¥å¿—æ–‡ä»¶åç§°
logfile "redis_6380.log"
# æŒ‡å®šç”Ÿæˆå¤‡ä»½æ•°æ®çš„æ–‡ä»¶ç›®å½•
dir /root/Dev_Azh/redis/data/6380
# æŒ‡å®šä¸»èŠ‚ç‚¹è¿æ¥ ip
replicaof 10.211.55.3 6379
```

ç¬¬äºŒä¸ªä»èŠ‚ç‚¹é…ç½®å¦‚ä¸‹ï¼š
```text
# æŒ‡å®šæœ¬æœºé€šè¿‡æœ¬æœºçš„å“ªä¸€ä¸ª ip åœ°å€æ¥æ¥æ”¶å¤–éƒ¨è¯·æ±‚ï¼Œè€Œä¸æ˜¯å…è®¸é‚£ä¸ª ip è®¿é—®
bind 0.0.0.0
# å…³é—­ä¿æŠ¤æ¨¡å¼
protected-mode no
# è®¾ç½® port ç«¯å£
port 6381
# è®¾ç½®åå°è¿è¡Œ
daemonize yes
# ä¿å­˜ redis è¿è¡Œçš„ pid, è¿›ç¨‹ç»“æŸåä¼šè‡ªåŠ¨åˆ é™¤
pidfile /var/run/redis_6381.pid
# ç”Ÿæˆæ—¥å¿—æ–‡ä»¶åç§°
logfile "redis_6381.log"
# æŒ‡å®šç”Ÿæˆå¤‡ä»½æ•°æ®çš„æ–‡ä»¶ç›®å½•
dir /root/Dev_Azh/redis/data/6381
# æŒ‡å®šä¸»èŠ‚ç‚¹è¿æ¥ ip
replicaof 10.211.55.3 6379
```
å…³é—­é˜²ç«å¢™
```shell
# æŸ¥çœ‹é˜²ç«å¢™çŠ¶æ€
firewall-cmd --state
# åœæ­¢é˜²ç«å¢™
systemctl stop firewalld.service
# ç¦æ­¢é˜²ç«å¢™å¼€æœºå¯åŠ¨
systemctl disable firewalld.service 
```


å¼€å§‹å¯åŠ¨å®ä¾‹
```shell
# å¯åŠ¨ä¸»èŠ‚ç‚¹å®ä¾‹
redis-server redis_6379.conf 
# æŸ¥çœ‹æœåŠ¡æ˜¯å¦å¯åŠ¨æˆåŠŸ
ps â€ef | grep redis
# ç»“æœï¼š
root      1599     1  0 20:27 ?        00:00:00 redis-server 0.0.0.0:6379

# å¯åŠ¨ä»èŠ‚ç‚¹å®ä¾‹
redis-server redis_6380.conf 
redis-server redis_6381.conf

# åœ¨ä¸»èŠ‚ç‚¹ä¸Šä½¿ç”¨å®¢æˆ·ç«¯è¿æ¥ redisï¼Œå¹¶è®¾ç½®æ•°æ®
redis-cli -p 6379
# è®¾ç½®æ•°æ®
127.0.0.1:6379> set master:10.211.55.3 "master"
# æ­¤æ—¶è¿æ¥ä¸¤ä¸ªä»èŠ‚ç‚¹å®¢æˆ·ç«¯ï¼ŒæŸ¥çœ‹æ•°æ®æ˜¯å¦åŒæ­¥
redis-cli -p 6380
127.0.0.1:6380> keys *
# è¾“å‡ºç»“æœï¼š
1) "master:10.211.55.3"

redis-cli -p 6381
127.0.0.1:6381> keys *
1) "master:10.211.55.3"
```
è‡³æ­¤ä¸»ä»ç»“æ„æ­å»ºæˆåŠŸã€‚


## Reids ä¸»ä»å·¥ä½œåŸç†
ä¸»ä»å¤åˆ¶è¿‡ç¨‹å¤§ä½“å¯ä»¥åˆ†ä¸º3ä¸ªé˜¶æ®µï¼šè¿æ¥å»ºç«‹é˜¶æ®µï¼ˆå³å‡†å¤‡é˜¶æ®µï¼‰ã€æ•°æ®åŒæ­¥é˜¶æ®µã€å‘½ä»¤ä¼ æ’­é˜¶æ®µã€‚

1. è¿æ¥å»ºç«‹é˜¶æ®µï¼š
   1. å…ˆåœ¨ç¼“å­˜ä¸­ä¿å­˜ master èŠ‚ç‚¹ä¿¡æ¯ï¼›æ—¥å¿—ä¿¡æ¯å¦‚ä¸‹ï¼š
   ```shell
   efore turning into a replica, using my master parameters to synthesize a cached master: I may be able to synchronize 
   with the new master with just a partial transfer
   ```
   2. å»ºç«‹ socket é•¿è¿æ¥ï¼›æ—¥å¿—ä¿¡æ¯å¦‚ä¸‹ï¼š
   ```shell
   Connecting to MASTER 10.211.55.3:6379
   MASTER <-> REPLICA sync started
   ```
   3. å‘é€ ping å‘½ä»¤ç¡®è®¤ä¸»æœºç½‘ç»œç•…é€šï¼›
   ```shell
   Master replied to PING, replication can continue...
   ```
2. æ•°æ®åŒæ­¥é˜¶æ®µ:
   1. ä»èŠ‚ç‚¹å¯åŠ¨ï¼Œæ€»ä¼šå‘ master å‘é€ä¸€ä¸ª psync(2.8ä»¥å‰å‘é€ sync å‘½ä»¤) å‘½ä»¤åˆ° master è¯·æ±‚å¤åˆ¶æ•°æ®ï¼›
   2. ä¸»èŠ‚ç‚¹æ”¶åˆ° psync å‘½ä»¤ä¼šåœ¨åå°è¿›è¡Œæ•°æ®æŒä¹…åŒ–é€šè¿‡bgsaveç”Ÿæˆæœ€æ–°çš„rdbå¿«ç…§æ–‡ä»¶, æŒä¹…åŒ–æœŸé—´ä»ç„¶ä¼šæ¥æ”¶å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼›
   3. åœ¨æŒä¹…åŒ–æœŸé—´ï¼Œmasterä¼šå°†æ¥æ”¶åˆ°å¯èƒ½ä¿®æ”¹æ•°æ®é›†çš„å‘½ä»¤ç¼“å­˜åˆ°å†…å­˜ä¸­ï¼›
   4. master æŒä¹…åŒ–å®Œæˆåï¼Œä¼šå°† rdb æ–‡ä»¶æ•°æ®é›†å‘ç»™ slave èŠ‚ç‚¹ï¼Œslave ä¼šå…ˆå°†è¿™äº›æ•°æ®ç”Ÿæˆ rdb æ–‡ä»¶ï¼Œç„¶åå†åŠ è½½åˆ°å†…å­˜ä¸­ï¼›
   5. æ¥ç€masterä¼šå°†ä¹‹å‰åŠ è½½åˆ°ç¼“å­˜ä¸­çš„å‘½ä»¤å‘é€ç»™ slave
3. å‘½ä»¤ä¼ æ’­é˜¶æ®µï¼š
   1. æ•°æ®åŒæ­¥é˜¶æ®µå®Œæˆåï¼Œä¸»ä»èŠ‚ç‚¹è¿›å…¥å‘½ä»¤ä¼ æ’­é˜¶æ®µï¼›åœ¨è¿™ä¸ªé˜¶æ®µä¸»èŠ‚ç‚¹å°†è‡ªå·±æ‰§è¡Œçš„å†™å‘½ä»¤å‘é€ç»™ä»èŠ‚ç‚¹ï¼Œä»èŠ‚ç‚¹æ¥æ”¶å‘½ä»¤å¹¶æ‰§è¡Œï¼Œä»è€Œä¿è¯ä¸»ä»èŠ‚ç‚¹æ•°æ®çš„ä¸€è‡´æ€§ã€‚
      
æ³¨æ„ï¼šå½“masterä¸slaveä¹‹é—´çš„è¿æ¥ç”±äºæŸäº›åŸå› è€Œæ–­å¼€æ—¶ï¼Œslaveèƒ½å¤Ÿè‡ªåŠ¨é‡è¿Masterï¼Œå¦‚æœmasteræ”¶åˆ°äº†å¤š ä¸ªslaveå¹¶å‘è¿æ¥è¯·æ±‚ï¼Œå®ƒåªä¼šè¿›è¡Œä¸€
æ¬¡æŒä¹…åŒ–ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªè¿æ¥ä¸€æ¬¡ï¼Œç„¶åå†æŠŠè¿™ä¸€ä»½æŒä¹…åŒ–çš„æ•°æ®å‘é€ ç»™å¤šä¸ªå¹¶å‘è¿æ¥çš„slaveã€‚

ä¸»ä»åŒæ­¥åŸç†å›¾(å…¨é‡æ•°æ®å¤åˆ¶)ï¼š
![](../photo/1.ä¸»ä»åŸç†å›¾.png)

### æ•°æ®éƒ¨åˆ†å¤åˆ¶
ä»èŠ‚ç‚¹æ–­å¼€ä¸ä¸»èŠ‚ç‚¹çš„è¿æ¥ï¼Œå†æ¬¡è¿æ¥çš„æ—¶å€™ï¼Œä¸€èˆ¬éƒ½ä¼šå¯¹æ•°æ®è¿›è¡Œå…¨é‡å¤åˆ¶ã€‚ä»redis2.8å¼€å§‹ï¼Œmasterå’Œå®ƒæ‰€æœ‰çš„ slaveéƒ½ç»´æŠ¤äº†å¤åˆ¶çš„æ•°æ®ä¸‹æ ‡
offsetå’Œmasterçš„è¿›ç¨‹idï¼Œå› æ­¤ï¼Œå½“ç½‘ç»œè¿æ¥æ–­å¼€åï¼Œslaveä¼šè¯·æ±‚master ç»§ç»­è¿›è¡Œæœªå®Œæˆçš„å¤åˆ¶ï¼Œä»æ‰€è®°å½•çš„æ•°æ®ä¸‹æ ‡å¼€å§‹ã€‚å¦‚æœmasterè¿›ç¨‹idå˜åŒ–äº†ï¼Œ
æˆ–è€…ä»èŠ‚ç‚¹æ•°æ®ä¸‹æ ‡ offset å¤ªæ—§ï¼Œå·²ç»ä¸åœ¨masterçš„ç¼“å­˜é˜Ÿåˆ—é‡Œäº†ï¼Œé‚£ä¹ˆå°†ä¼šè¿›è¡Œä¸€æ¬¡å…¨é‡æ•°æ®çš„å¤åˆ¶ã€‚è¿™ç§æœºåˆ¶å°±å«**æ–­ç‚¹ç»­ä¼ **

å¦‚å›¾æ‰€ç¤ºï¼š
![](../photo/2.ä¸»ä»å¤åˆ¶-æ–­ç‚¹ç»­ä¼ .png)
æ³¨æ„ï¼šå¦‚æœæœ‰å¾ˆå¤šä»èŠ‚ç‚¹ï¼Œä¸ºäº†ç¼“è§£ä¸»ä»å¤åˆ¶é£æš´(å¤šä¸ªä»èŠ‚ç‚¹åŒæ—¶å¤åˆ¶ä¸»èŠ‚ç‚¹å¯¼è‡´ä¸»èŠ‚ç‚¹å‹åŠ›è¿‡å¤§)ï¼Œå¯ä»¥åšå¦‚ä¸‹æ¶æ„ï¼Œè®©éƒ¨åˆ†ä»èŠ‚ç‚¹ä¸ä»èŠ‚ç‚¹(ä¸ä¸»èŠ‚ç‚¹åŒæ­¥)
åŒæ­¥æ•°æ®ã€‚

## Jedis è¿æ¥ä»£ç å®ä¾‹
å¼•å…¥ç›¸å…³ä¾èµ–
```xml
   <dependency>
      <groupId>redis.clients</groupId>
      <artifactId>jedis</artifactId>
      <version>2.9.0</version>
   </dependency>
```

ç¨‹åº demo
```java
public class JedisDemo {
    public static void main(String[] args) throws IOException {
        JedisPoolConfig jedisPoolConfig = new JedisPoolConfig();
        jedisPoolConfig.setMaxTotal(20);
        jedisPoolConfig.setMaxIdle(10);
        jedisPoolConfig.setMinIdle(5);

        // timeoutï¼Œè¿™é‡Œæ—¢æ˜¯è¿æ¥è¶…æ—¶åˆæ˜¯è¯»å†™è¶…æ—¶ï¼Œä»Jedis 2.8å¼€å§‹æœ‰åŒºåˆ†connectionTimeoutå’ŒsoTimeo tçš„æ„é€ å‡½æ•°
        JedisPool jedisPool = new JedisPool(jedisPoolConfig, "10.211.55.3", 6379, 3000, null);
        Jedis jedis = null;
        
        try{
            //ä»redisè¿æ¥æ± é‡Œæ‹¿å‡ºä¸€ä¸ªè¿æ¥æ‰§è¡Œå‘½ä»¤
            jedis = jedisPool.getResource();
            System.out.println(jedis.set("single", "zhuge"));
            System.out.println(jedis.get("single"));
            //ç®¡é“ç¤ºä¾‹
            //ç®¡é“çš„å‘½ä»¤æ‰§è¡Œæ–¹å¼:cat redis.txt | redisâ€cli â€h 127.0.0.1 â€a password â€ p 6379 â€â€pipe
            /*Pipeline pl = jedis.pipelined();
            for(inti=0;i<10;i++){
                pl.incr("pipelineKey");
                pl.set("zhuge" + i, "zhuge");
            }
             */
            //luaè„šæœ¬æ¨¡æ‹Ÿä¸€ä¸ªå•†å“å‡åº“å­˜çš„åŸå­æ“ä½œ
            //luaè„šæœ¬å‘½ä»¤æ‰§è¡Œæ–¹å¼:redisâ€cli â€â€eval /tmp/test.lua , 10
            /*jedis.set("product_count_10016", "15"); //åˆå§‹åŒ–å•†å“10016çš„åº“å­˜*/
            String script = " local count = redis.call('get', KEYS[1]) " + " local a = tonumber(count) " +
                    " local b = tonumber(ARGV[1]) " + "ifa>=bthen" + " redis.call('set', KEYS[1], aâ€b) " +
                    "end" + " return 0 ";
            Object obj = jedis.eval(script, Arrays.asList("product_count_10016"), Arrays.asList("10"));
            System.out.println(obj);
        }catch (Exception e){
            //æ³¨æ„è¿™é‡Œä¸æ˜¯å…³é—­è¿æ¥ï¼Œåœ¨JedisPoolæ¨¡å¼ä¸‹ï¼ŒJedisä¼šè¢«å½’è¿˜ç»™èµ„æºæ± ã€‚
            if (jedis != null){
                jedis.close();
            }
        }
    }
}
```
## ç®¡é“(Pipeline)
å®¢æˆ·ç«¯å¯ä»¥ä¸€æ¬¡æ€§å‘é€å¤šä¸ªè¯·æ±‚è€Œä¸ç”¨ç­‰å¾…æœåŠ¡å™¨çš„å“åº”ï¼Œå¾…æ‰€æœ‰å‘½ä»¤éƒ½å‘é€å®Œåå†ä¸€æ¬¡æ€§è¯»å–æœåŠ¡çš„å“åº”ï¼Œè¿™æ ·å¯ä»¥æå¤§çš„é™ä½å¤šæ¡å‘½ä»¤æ‰§è¡Œçš„ç½‘ç»œä¼ è¾“
å¼€é”€ï¼Œç®¡é“æ‰§è¡Œå¤šæ¡å‘½ä»¤çš„ç½‘ç»œå¼€é”€å®é™…ä¸Šåªç›¸å½“äºä¸€æ¬¡å‘½ä»¤æ‰§è¡Œçš„ç½‘ç»œå¼€é”€ã€‚éœ€è¦æ³¨æ„åˆ°æ˜¯ç”¨pipelineæ–¹å¼æ‰“åŒ…å‘½ä»¤å‘é€ï¼Œrediså¿…é¡»åœ¨å¤„ç†å®Œæ‰€æœ‰å‘½ä»¤
å‰å…ˆç¼“å­˜èµ·æ‰€æœ‰å‘½ä»¤çš„å¤„ç†ç»“æœã€‚æ‰“åŒ…çš„å‘½ä»¤è¶Šå¤šï¼Œç¼“å­˜æ¶ˆè€—å†…å­˜ä¹Ÿè¶Šå¤šã€‚æ‰€ä»¥å¹¶ä¸æ˜¯æ‰“åŒ…çš„å‘½ä»¤è¶Šå¤šè¶Šå¥½ã€‚pipelineä¸­å‘é€çš„æ¯ä¸ªcommandéƒ½ä¼šè¢«
serverç«‹å³æ‰§è¡Œï¼Œå¦‚æœæ‰§è¡Œå¤±è´¥ï¼Œå°†ä¼šåœ¨æ­¤åçš„å“åº”ä¸­å¾—åˆ°ä¿¡æ¯;ä¹Ÿå°±æ˜¯pipelineå¹¶ä¸æ˜¯è¡¨è¾¾â€œæ‰€æœ‰commandéƒ½ä¸€èµ·æˆåŠŸâ€çš„è¯­ä¹‰ï¼Œç®¡é“ä¸­å‰é¢å‘½ä»¤å¤±è´¥ï¼Œ
åé¢å‘½ä»¤ä¸ä¼šæœ‰å½±å“ï¼Œç»§ç»­æ‰§è¡Œã€‚

```java
package com.anzhi.masterslavejedis;

public class JedisMasterSlaveDemo {
    public static void main(String[] args) throws IOException {
        JedisPoolConfig jedisPoolConfig = new JedisPoolConfig();
        jedisPoolConfig.setMaxTotal(20);
        jedisPoolConfig.setMaxIdle(10);
        jedisPoolConfig.setMinIdle(5);

        // timeoutï¼Œè¿™é‡Œæ—¢æ˜¯è¿æ¥è¶…æ—¶åˆæ˜¯è¯»å†™è¶…æ—¶ï¼Œä»Jedis 2.8å¼€å§‹æœ‰åŒºåˆ†connectionTimeoutå’ŒsoTimeo tçš„æ„é€ å‡½æ•°
        JedisPool jedisPool = new JedisPool(jedisPoolConfig, "10.211.55.3", 6379, 3000, null);
        Jedis jedis = null;
        
        try{
            //ä»redisè¿æ¥æ± é‡Œæ‹¿å‡ºä¸€ä¸ªè¿æ¥æ‰§è¡Œå‘½ä»¤
            jedis = jedisPool.getResource();
            System.out.println(jedis.set("single", "zhuge"));
            System.out.println(jedis.get("single"));
            //ç®¡é“ç¤ºä¾‹
            //ç®¡é“çš„å‘½ä»¤æ‰§è¡Œæ–¹å¼:cat redis.txt | redisâ€cli â€h 127.0.0.1 â€a password â€ p 6379 â€â€pipe
            Pipeline pl = jedis.pipelined();
            for(int i=0;i<10;i++){
                pl.incr("pipelineKey");
                pl.set("zhangsan" + i, "zhuge");
                // æ¨¡æ‹Ÿç®¡é“æŠ¥é”™
                pl.setbit("zhangsan", -1, true);
            }
            List<Object> results=pl.syncAndReturnAll();
            System.out.println(results);
        }catch (Exception e){
            //æ³¨æ„è¿™é‡Œä¸æ˜¯å…³é—­è¿æ¥ï¼Œåœ¨JedisPoolæ¨¡å¼ä¸‹ï¼ŒJedisä¼šè¢«å½’è¿˜ç»™èµ„æºæ± ã€‚
            if (jedis != null){
                jedis.close();
            }
        }
    }
}
```
Redis 2.6 æ¨å‡ºäº†è„šæœ¬åŠŸèƒ½ï¼Œå…è®¸å¼€å‘è€…ä½¿ç”¨Luaè¯­è¨€ç¼–å†™è„šæœ¬ä¼ åˆ°Redisä¸­æ‰§è¡Œã€‚ä½¿ç”¨è„šæœ¬çš„å¥½å¤„å¦‚ä¸‹ï¼š
1. **å‡å°‘ç½‘ç»œå¼€é”€**ï¼šæœ¬æ¥5æ¬¡ç½‘ç»œè¯·æ±‚çš„æ“ä½œï¼Œå¯ä»¥ç”¨ä¸€ä¸ªè¯·æ±‚å®Œæˆï¼ŒåŸå…ˆ5æ¬¡è¯·æ±‚çš„é€»è¾‘æ”¾åœ¨redisæœåŠ¡å™¨ ä¸Šå®Œæˆã€‚ä½¿ç”¨è„šæœ¬ï¼Œå‡å°‘äº†ç½‘ç»œå¾€è¿”æ—¶å»¶ã€‚è¿™ç‚¹è·Ÿç®¡é“ç±»ä¼¼ã€‚
2. **åŸå­æ“ä½œ**ï¼šRedisä¼šå°†æ•´ä¸ªè„šæœ¬ä½œä¸ºä¸€ä¸ªæ•´ä½“æ‰§è¡Œï¼Œä¸­é—´ä¸ä¼šè¢«å…¶ä»–å‘½ä»¤æ’å…¥ã€‚ç®¡é“ä¸æ˜¯åŸå­çš„ï¼Œä¸è¿‡ redisçš„æ‰¹é‡æ“ä½œå‘½ä»¤(ç±»ä¼¼mset)æ˜¯åŸå­çš„ã€‚
3. **æ›¿ä»£redisçš„äº‹åŠ¡åŠŸèƒ½**:redisè‡ªå¸¦çš„äº‹åŠ¡åŠŸèƒ½å¾ˆé¸¡è‚‹ï¼Œè€Œredisçš„luaè„šæœ¬å‡ ä¹å®ç°äº†å¸¸è§„çš„äº‹åŠ¡åŠŸèƒ½ï¼Œ å®˜æ–¹æ¨èå¦‚æœè¦ä½¿ç”¨redisçš„äº‹åŠ¡åŠŸèƒ½å¯ä»¥ç”¨redis luaæ›¿ä»£ã€‚

# Redis å“¨å…µé«˜å¯ç”¨æ¶æ„
ä¸»ä»æ¶æ„ä¸€æ—¦ä¸»èŠ‚ç‚¹æŒ‚äº†ï¼Œå°±éœ€è¦äººå·¥å»ç»´æŠ¤ï¼Œè¿™è‚¯å®šæ˜¯æˆ‘ä»¬ä¸èƒ½æ¥å—çš„ã€‚Redis æœ‰ä¸“é—¨çš„ Sentinel ç›‘æ§æœºåˆ¶ã€‚ä¸‹é¢æ¥æ­å»ºä¸€ä¸‹å“¨å…µé›†ç¾¤ã€‚
é…ç½® sentinel.conf æ–‡ä»¶

ä¸»èŠ‚ç‚¹çš„ sentinel é…ç½®
```text
# port ç«¯å£ä¿®æ”¹
port 26379
# è®¾ç½®åå°è¿è¡Œ
daemonize yes
# è®¾ç½®ä¿å­˜ redis-sentinel è¿›ç¨‹idçš„æ–‡ä»¶åç§°
pidfile /var/run/redis-sentinel-26379.pid
# è®¾ç½®ä¿å­˜æ—¥å¿—æ–‡ä»¶çš„åç§°
logfile "redis-sentinel-26379.log"
# è®¾ç½®ä¿å­˜æ•°æ®çš„æ–‡ä»¶ç›®å½•
dir /root/Dev_Azh/redis/data/26379
# è®¾ç½®è¦ç›‘æ§çš„ä¸»èŠ‚ç‚¹
sentinel monitor mymaster 10.211.55.3 6379 2
```

ä»èŠ‚ç‚¹ sentinel çš„é…ç½®
```text
# port ç«¯å£ä¿®æ”¹
port 26380
# è®¾ç½®åå°è¿è¡Œ
daemonize yes
# è®¾ç½®ä¿å­˜ redis-sentinel è¿›ç¨‹idçš„æ–‡ä»¶åç§°
pidfile /var/run/redis-sentinel-26380.pid
# è®¾ç½®ä¿å­˜æ—¥å¿—æ–‡ä»¶çš„åç§°
logfile "redis-sentinel-26380.log"
# è®¾ç½®ä¿å­˜æ•°æ®çš„æ–‡ä»¶ç›®å½•
dir /root/Dev_Azh/redis/data/26380
# è®¾ç½®è¦ç›‘æ§çš„ä¸»èŠ‚ç‚¹
sentinel monitor mymaster 10.211.55.3 6379 2

# port ç«¯å£ä¿®æ”¹
port 26381
# è®¾ç½®åå°è¿è¡Œ
daemonize yes
# è®¾ç½®ä¿å­˜ redis-sentinel è¿›ç¨‹idçš„æ–‡ä»¶åç§°
pidfile /var/run/redis-sentinel-26381.pid
# è®¾ç½®ä¿å­˜æ—¥å¿—æ–‡ä»¶çš„åç§°
logfile "redis-sentinel-26381.log"
# è®¾ç½®ä¿å­˜æ•°æ®çš„æ–‡ä»¶ç›®å½•
dir /root/Dev_Azh/redis/data/26381
# è®¾ç½®è¦ç›‘æ§çš„ä¸»èŠ‚ç‚¹
sentinel monitor mymaster 10.211.55.3 6379 2
```

ä¸Šé¢æˆ‘ä»¬å·²ç»é…ç½®å¥½äº†ä¸»ä»èŠ‚ç‚¹çš„é›†ç¾¤ï¼Œé‚£ä¸ªé…ç½®éƒ½ä¸éœ€è¦æ”¹ã€‚åœ¨å¯åŠ¨ä¸»ä»é›†ç¾¤ä¹‹åï¼Œå†å¯åŠ¨ sentinel ç›‘æ§
```shell
# å¯åŠ¨ä¸»èŠ‚ç‚¹ç›‘æ§
redis-sentinel sentinel_26379.conf
redis-sentinel sentinel_26380.conf 
redis-sentinel sentinel_26381.conf

# æŸ¥çœ‹æ˜¯å¦å¯åŠ¨æˆåŠŸï¼š
ps -ef | grep redis
root      1772     1  0 21:09 ?        00:00:04 redis-sentinel *:26379 [sentinel]
root      1880     1  0 21:27 ?        00:00:00 redis-server 0.0.0.0:6379

# å®¢æˆ·ç«¯è¿æ¥ sentinel æœåŠ¡
redis-cli -p 26379
# ç”¨ info æŸ¥çœ‹ä¿¡æ¯
# Sentinel
sentinel_masters:1
sentinel_tilt:0
sentinel_running_scripts:0
sentinel_scripts_queue_length:0
sentinel_simulate_failure_flags:0
master0:name=mymaster,status=ok,address=10.211.55.4:6380,slaves=2,sentinels=3
```
å¯ä»¥çœ‹åˆ°å½“å‰ä¸»èŠ‚ç‚¹æ˜¯ 10.211.55.4, é‚£ä¹ˆå°†ä¸»èŠ‚ç‚¹æŒ‚æ‰ï¼ŒéªŒè¯æ•…éšœè‡ªåŠ¨æ¢å¤ï¼š
```text
# åœ¨ä¸»èŠ‚ç‚¹å¯¹åº”çš„è™šæœºä¸Šå°†redisæœåŠ¡ kill
ps -ef | grep redis
root      1610     1  0 20:28 ?        00:00:06 redis-server 0.0.0.0:6380
root      1768     1  0 21:04 ?        00:00:05 redis-sentinel *:26380 [sentinel]
root      1891  1585  0 21:33 pts/0    00:00:00 grep --color=auto redis

# æ€æ­»è¿›ç¨‹
kill -9 1610

# åœ¨è¯¥ä¸»æœºä¸Šè¿æ¥ sentinel æœåŠ¡
redis-cli -p 26380
# æŸ¥çœ‹ä¸»èŠ‚ç‚¹ä¿¡æ¯
127.0.0.1:26379> info

# Sentinel
sentinel_masters:1
sentinel_tilt:0
sentinel_running_scripts:0
sentinel_scripts_queue_length:0
sentinel_simulate_failure_flags:0
master0:name=mymaster,status=ok,address=10.211.55.3:6379,slaves=2,sentinels=3
```
å¯ä»¥çœ‹åˆ°ä¸»èŠ‚ç‚¹ä» 10.211.55.4 å˜æˆäº† 10.211.55.3 è¿™ä¸ªèŠ‚ç‚¹ã€‚

## ä»£ç éªŒè¯
pom.xml ä¾èµ–
```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <groupId>org.example</groupId>
    <artifactId>redis</artifactId>
    <version>1.0-SNAPSHOT</version>

    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>2.3.1.RELEASE</version>
        <relativePath/> <!-- lookup parent from repository -->
    </parent>

    <properties>
        <maven.compiler.source>8</maven.compiler.source>
        <maven.compiler.target>8</maven.compiler.target>
    </properties>
    
    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-redis</artifactId>
        </dependency>

        <dependency>
            <groupId>org.apache.commons</groupId>
            <artifactId>commons-pool2</artifactId>
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
        
        <dependency>
            <groupId>redis.clients</groupId>
            <artifactId>jedis</artifactId>
            <version>2.9.0</version>
        </dependency>
    </dependencies>

    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
            </plugin>
        </plugins>
    </build>

</project>
```

yaml æ–‡ä»¶é…ç½®
```yaml
server:
  port: 8080
  
spring:
  redis:
    database: 0
    timeout: 3000
    sentinel:
      master: mymaster
      nodes: 10.211.55.3:26379,10.211.55.4:26380,10.211.55.5:26381
    lettuce:
      pool:
        max-idle: 50
        min-idle: 10
        max-active: 100
        max-wait: 1000
```

è¿æ¥redis demo
```java
package com.anzhi.sentineljedis.service;

import redis.clients.jedis.HostAndPort;
import redis.clients.jedis.Jedis;
import redis.clients.jedis.JedisPoolConfig;
import redis.clients.jedis.JedisSentinelPool;

import java.util.HashSet;
import java.util.Set;

public class JedisSentinelDemo {
    public static void main(String[] args) {
        JedisPoolConfig config = new JedisPoolConfig();
        config.setMaxTotal(20);
        config.setMaxIdle(10);
        config.setMinIdle(5);

        String masterName = "mymaster";
        Set<String> sentinels = new HashSet<String>();
        sentinels.add(new HostAndPort("10.211.55.3",26379).toString());
        sentinels.add(new HostAndPort("10.211.55.4",26380).toString());
        sentinels.add(new HostAndPort("10.211.55.5",26381).toString());

        //JedisSentinelPoolå…¶å®æœ¬è´¨è·ŸJedisPoolç±»ä¼¼ï¼Œéƒ½æ˜¯ä¸redisä¸»èŠ‚ç‚¹å»ºç«‹çš„è¿æ¥æ± 
        //JedisSentinelPoolå¹¶ä¸æ˜¯è¯´ä¸sentinelå»ºç«‹çš„è¿æ¥æ± ï¼Œè€Œæ˜¯é€šè¿‡sentinelå‘ç°redisä¸»èŠ‚ç‚¹å¹¶ä¸å…¶å»ºç«‹è¿æ¥
        JedisSentinelPool jedisSentinelPool = new JedisSentinelPool(masterName, sentinels, config, 3000, null);
        Jedis jedis = null;
        try{
            jedis = jedisSentinelPool.getResource();
            System.out.println(jedis.set("sentinel", "masterA"));
            System.out.println(jedis.get("sentinel"));
            System.out.println(jedis.del("sentinel"));
        }catch (Exception e){
            // doNothing
        }finally {
            //æ³¨æ„è¿™é‡Œä¸æ˜¯å…³é—­è¿æ¥ï¼Œåœ¨JedisPoolæ¨¡å¼ä¸‹ï¼ŒJedisä¼šè¢«å½’è¿˜ç»™èµ„æºæ± ã€‚
            if (jedis != null){
                jedis.close();
            }
        }
    }
}
```
Controller å±‚æ¥å£
```java
package com.anzhi.sentineljedis.controller;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.redis.core.StringRedisTemplate;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class SentinelIndexCOntroller {
    private static final Logger logger = LoggerFactory.getLogger(SentinelIndexCOntroller.class);
    @Autowired
    private StringRedisTemplate stringRedisTemplate;

    /**
     * æµ‹è¯•èŠ‚ç‚¹æŒ‚äº†å“¨å…µé‡æ–°é€‰ä¸¾æ–°çš„masterèŠ‚ç‚¹ï¼Œå®¢æˆ·ç«¯æ˜¯å¦èƒ½åŠ¨æ€æ„ŸçŸ¥åˆ°
     *
     * @throws InterruptedException
     */
    @RequestMapping("/test_sentinel")
    public void testSentinel() throws InterruptedException {
        int i = 1;
        while (true){
            try{
                stringRedisTemplate.opsForValue().set("master"+i, i+""); //jedis.set(key,value);
                System.out.println("è®¾ç½®keyï¼š"+ "master" + i);
                Thread.sleep(10000);
                stringRedisTemplate.delete("master" + i);
                i++;
            }catch (Exception e){
                logger.error("é”™è¯¯ï¼š", e);
            }
        }
    }
}
```
è¿™æ®µç¨‹åºä¸»è¦å¹²çš„äº‹å„¿æ˜¯ï¼šå…ˆè®¾ç½®é”®å€¼ï¼Œç„¶åä¼‘çœ 10ï¼Œåœ¨åˆ é™¤ keyã€‚ä¸€ç›´å¾ªç¯

å¯åŠ¨ç±»
```java
package com.anzhi.sentineljedis;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class SentinelApplication {
    public static void main(String[] args) {
        SpringApplication.run(SentinelApplication.class, args);
    }
}
```
ç¨‹åºå¯åŠ¨åï¼Œé€šè¿‡é“¾æ¥ http://localhost:8080/test_sentinel è®¿é—®ã€‚æ­¤æ—¶æ§åˆ¶å°ä¼šè¾“å‡ºï¼š
```text
è®¾ç½®keyï¼šmaster1
è®¾ç½®keyï¼šmaster2
è®¾ç½®keyï¼šmaster3
è®¾ç½®keyï¼šmaster4
è®¾ç½®keyï¼šmaster5
è®¾ç½®keyï¼šmaster6
è®¾ç½®keyï¼šmaster7
è®¾ç½®keyï¼šmaster8
è®¾ç½®keyï¼šmaster9
```
æ¥ä¸‹æ¥æˆ‘ä»¬å…³é—­ä¸»èŠ‚ç‚¹ï¼Œæ­¤æ—¶æ§åˆ¶å°è¾“å‡ºï¼š
```text
2023-03-02 21:44:51.256  INFO 11153 --- [xecutorLoop-1-3] i.l.core.protocol.ConnectionWatchdog     : Reconnecting, last destination was /10.211.55.5:6381
2023-03-02 21:44:51.376  WARN 11153 --- [ioEventLoop-4-4] i.l.core.protocol.ConnectionWatchdog     : Cannot reconnect to [10.211.55.5:6381]: Connection refused: /10.211.55.5:6381
2023-03-02 21:44:57.259  INFO 11153 --- [xecutorLoop-1-9] i.l.core.protocol.ConnectionWatchdog     : Reconnecting, last destination was 10.211.55.5:6381
2023-03-02 21:44:57.365  WARN 11153 --- [oEventLoop-4-10] i.l.core.protocol.ConnectionWatchdog     : Cannot reconnect to [10.211.55.5:6381]: Connection refused: /10.211.55.5:6381
2023-03-02 21:45:03.865 ERROR 11153 --- [nio-8080-exec-1] c.a.s.c.SentinelIndexCOntroller          : é”™è¯¯ï¼š

org.springframework.dao.QueryTimeoutException: Redis command timed out; nested exception is io.lettuce.core.RedisCommandTimeoutException: Command timed out after 3 second(s)
```
å¯ä»¥çœ‹åˆ°ï¼Œä¸»èŠ‚ç‚¹æ•…éšœï¼Œå¯¼è‡´ç¨‹åºå¼‚å¸¸ã€‚åœ¨ç¨‹åºè¿è¡Œäº†ä¸€æ®µæ—¶é—´åï¼Œé‡æ–°è¿æ¥åˆ°äº†ä¸»èŠ‚ç‚¹ï¼š
```text
2023-03-02 21:45:26.460  INFO 11153 --- [xecutorLoop-1-8] i.l.core.protocol.ConnectionWatchdog     : Reconnecting, last destination was 10.211.55.5:6381
2023-03-02 21:45:26.466  INFO 11153 --- [oEventLoop-4-16] i.l.core.protocol.ReconnectionHandler    : Reconnected to 10.211.55.3:6379
è®¾ç½®keyï¼šmaster9
è®¾ç½®keyï¼šmaster10
```
ä½†æ˜¯æ­¤æ—¶ä¸»èŠ‚ç‚¹å·²ç»å‘ç”Ÿäº†å˜åŒ–ï¼Œå˜æˆäº† 10.211.55.3:6379ï¼Œç„¶åç¨‹åºç»§ç»­è¿è¡Œã€‚

# Redis Cluster(Redis é›†ç¾¤)
æ ¹æ®å¯¹ Sentinel æµ‹è¯•å…¶å®ä¼šå‘ç°è™½ç„¶æ•…éšœå¯ä»¥è‡ªåŠ¨æ¢å¤ï¼Œä½†æ˜¯åœ¨æ•…éšœæ¢å¤æœŸé—´ï¼Œredis æœåŠ¡æ˜¯å¤„äºä¸å¯ç”¨çš„çŠ¶æ€ã€‚å¦ä¸€æ–¹é¢ï¼Œç”±äºåªæœ‰ä¸»èŠ‚ç‚¹æä¾›å†™æœåŠ¡ï¼Œ
æ— æ³•æ”¯æŒå¾ˆé«˜çš„å¹¶å‘ã€‚æœ€åå°±æ˜¯ redis å®¹é‡æœ‰é™ï¼Œé¢å¯¹é‚£äº›å¤§å…¬å¸æ¯”è¾ƒä¾èµ– redis ç¼“å­˜çš„æƒ…å†µä¸‹ï¼Œå•ä¸€é›†ç¾¤æ ¹æœ¬å°±ä¸å¤Ÿç”¨ã€‚è¿™æ—¶å¯èƒ½ä¼šæƒ³æŠŠ redis å®¹é‡
æ‰©å¤§å°±å¥½äº†å‘€ï¼Œä½†æ˜¯éšä¹‹è€Œæ¥çš„é—®é¢˜æ˜¯æ•°æ®å¤‡ä»½çš„é—®é¢˜ã€‚å®¹é‡å¤§æ„å‘³ç€ AOF çš„æ–‡ä»¶å°†æ¥ä¼šå¾ˆå¤§ï¼Œé‚£ä¹ˆæ•°æ®æ¢å¤æ—¶é—´ä¹Ÿå°±ä¼šå¾ˆé•¿ï¼Œä»è€Œå¯¼è‡´ä¸»ä»æ•°æ®åŒæ­¥æ—¶é—´
ä¹Ÿä¼šå¢åŠ ã€‚æ˜¾ç„¶è¿™ç§æ–¹æ¡ˆæ˜¯ä¸å¯å–çš„ã€‚

åœ¨ Redis 3.0 æä¾›äº†ä¸€ç§é«˜å¯ç”¨é›†ç¾¤æ¨¡å¼ï¼Œå®ƒå…·æœ‰å¤åˆ¶ã€é«˜å¯ç”¨å’Œåˆ†ç‰‡ç‰¹æ€§ï¼Œå³ä¿è¯äº† CAP ä¸­çš„ AP ç‰¹æ€§ã€‚Redis é›†ç¾¤ä¸éœ€è¦ sentinel å“¨å…µä¹Ÿèƒ½å®Œæˆ
èŠ‚ç‚¹ç§»é™¤å’Œæ•…éšœæ¢å¤çš„åŠŸèƒ½ã€‚è¿™ç§é›†ç¾¤æ¨¡å¼æ²¡æœ‰ä¸­å¿ƒèŠ‚ç‚¹ï¼Œå¯æ°´å¹³æ‰©å±•ã€‚å› æ­¤ä¹Ÿå°±ä¸å­˜åœ¨å®¹é‡çš„é—®é¢˜ã€‚

## Redis é›†ç¾¤æ­å»º
redisé«˜å¯ç”¨é›†ç¾¤è‡³å°‘éœ€è¦ä¸‰ä¸ªmasterèŠ‚ç‚¹ï¼Œæˆ‘ä»¬æ­å»ºä¸‰ä¸ª master èŠ‚ç‚¹å¹¶ç»™æ¯ä¸ª master èŠ‚ç‚¹é…ç½®ä¸€ä¸ª slave èŠ‚ç‚¹ã€‚è¿™é‡Œä½¿ç”¨ä¸‰å°è™šæœºæ­å»ºï¼Œæ¯å°è™šæœº
æ­å»ºä¸€ä¸»ä¸€ä»ã€‚

ä¿®æ”¹ç¬¬ä¸€ä¸ªä¸»èŠ‚ç‚¹ 8001 æ–‡ä»¶
```text
bind 0.0.0.0
protected-mode no
port 8001
daemonize yes
pidfile /var/run/redis_cluster_8001.pid
logfile "redis_cluster_8001.log"
dir /root/Dev_Azh/redis/data/8001/
# å¼€å¯ redis-cluster é›†ç¾¤æ¨¡å¼
cluster-enabled yes
# é›†ç¾¤ä¿¡æ¯èŠ‚ç‚¹æ–‡ä»¶
cluster-config-file nodes-8001.conf
# è¿æ¥è¶…æ—¶æ—¶é—´
cluster-node-timeout 10000
appendonly yes
```
ä¿®æ”¹ 8002 æ–‡ä»¶
```text
bind 0.0.0.0
protected-mode no
port 8002
daemonize yes
pidfile /var/run/redis_cluster_8002.pid
logfile "redis_cluster_8002.log"
dir /root/Dev_Azh/redis/data/8002/
# å¼€å¯ redis-cluster é›†ç¾¤æ¨¡å¼
cluster-enabled yes
# é›†ç¾¤ä¿¡æ¯èŠ‚ç‚¹æ–‡ä»¶
cluster-config-file nodes-8002.conf
# è¿æ¥è¶…æ—¶æ—¶é—´
cluster-node-timeout 10000
appendonly yes
```
ä¿®æ”¹ 8003 æ–‡ä»¶
```text
bind 0.0.0.0
protected-mode no
port 8003
daemonize yes
pidfile /var/run/redis_cluster_8003.pid
logfile "redis_cluster_8003.log"
dir /root/Dev_Azh/redis/data/8003/
# å¼€å¯ redis-cluster é›†ç¾¤æ¨¡å¼
cluster-enabled yes
# é›†ç¾¤ä¿¡æ¯èŠ‚ç‚¹æ–‡ä»¶
cluster-config-file nodes-8003.conf
# è¿æ¥è¶…æ—¶æ—¶é—´
cluster-node-timeout 10000
appendonly yes
```
ä¿®æ”¹ 8004 æ–‡ä»¶
```text
bind 0.0.0.0
protected-mode no
port 8004
daemonize yes
pidfile /var/run/redis_cluster_8004.pid
logfile "redis_cluster_8004.log"
dir /root/Dev_Azh/redis/data/8004/
# å¼€å¯ redis-cluster é›†ç¾¤æ¨¡å¼
cluster-enabled yes
# é›†ç¾¤ä¿¡æ¯èŠ‚ç‚¹æ–‡ä»¶
cluster-config-file nodes-8004.conf
# è¿æ¥è¶…æ—¶æ—¶é—´
cluster-node-timeout 10000
appendonly yes
```
ä¿®æ”¹ 8005 æ–‡ä»¶
```text
bind 0.0.0.0
protected-mode no
port 8005
daemonize yes
pidfile /var/run/redis_cluster_8005.pid
logfile "redis_cluster_8005.log"
dir /root/Dev_Azh/redis/data/8005/
# å¼€å¯ redis-cluster é›†ç¾¤æ¨¡å¼
cluster-enabled yes
# é›†ç¾¤ä¿¡æ¯èŠ‚ç‚¹æ–‡ä»¶
cluster-config-file nodes-8005.conf
# è¿æ¥è¶…æ—¶æ—¶é—´
cluster-node-timeout 10000
appendonly yes
```
ä¿®æ”¹ 8006 æ–‡ä»¶
```text
bind 0.0.0.0
protected-mode no
port 8006
daemonize yes
pidfile /var/run/redis_cluster_8006.pid
logfile "redis_cluster_8006.log"
dir /root/Dev_Azh/redis/data/8006/
# å¼€å¯ redis-cluster é›†ç¾¤æ¨¡å¼
cluster-enabled yes
# é›†ç¾¤ä¿¡æ¯èŠ‚ç‚¹æ–‡ä»¶
cluster-config-file nodes-8006.conf
# è¿æ¥è¶…æ—¶æ—¶é—´
cluster-node-timeout 10000
appendonly yes
```
é…ç½®å®Œæˆåï¼Œå¯åŠ¨è¿™ 6 ä¸ª redis å®ä¾‹
```shell
redis-server redis_cluster_8001.conf 
redis-server redis_cluster_8002.conf
redis-server redis_cluster_8003.conf
redis-server redis_cluster_8004.conf 
redis-server redis_cluster_8005.conf 
redis-server redis_cluster_8006.conf 
```
å¯åŠ¨æˆåŠŸåï¼Œä½¿ç”¨ redis-cli å‘½ä»¤åˆ›å»ºé›†ç¾¤ã€‚é¦–å…ˆå…ˆç¡®å®šå„ä¸ªè™šæœºä¹‹é—´å¯ä»¥é€šè¿‡å®¢æˆ·ç«¯äº’è”
```shell
# åœ¨ 10.211.55.3 ä¸Šè¿æ¥ 10.211.55.4 çš„ redis æœåŠ¡
redis-cli -h 10.211.55.4 -p 8003
redis-cli -h 10.211.55.4 -p 800
```
åœ¨æ¯å°è™šæœºä¸Šç¡®è®¤è¿æ¥å…¶ä»–è™šæœºçš„ redis æœåŠ¡æ­£å¸¸åï¼Œå¼€å§‹å»ºç«‹é›†ç¾¤
```shell
redis-cli --cluster create --cluster-replicas 1 10.211.55.3:8001 10.211.55.5:8006 10.211.55.4:8003 10.211.55.3:8002 10.211.55.5:8005 10.211.55.4:8004
# è¾“å‡ºä¿¡æ¯
>>> Performing hash slots allocation on 6 nodes...
Master[0] -> Slots 0 - 5460
Master[1] -> Slots 5461 - 10922
Master[2] -> Slots 10923 - 16383
Adding replica 10.211.55.5:8005 to 10.211.55.3:8001
Adding replica 10.211.55.4:8004 to 10.211.55.5:8006
Adding replica 10.211.55.3:8002 to 10.211.55.4:8003
M: 996869f6edf22608d407b99726b3b0e80c5ac194 10.211.55.3:8001
   slots:[0-5460] (5461 slots) master
M: 42ae80c2a513b5484088f88611d3aca8988d7528 10.211.55.5:8006
   slots:[5461-10922] (5462 slots) master
M: 7c87165c1753858ee51ca350253e17b09fab4917 10.211.55.4:8003
   slots:[10923-16383] (5461 slots) master
S: fde4695b37f216d6fec57acfc3b136c102fc3579 10.211.55.3:8002
   replicates 7c87165c1753858ee51ca350253e17b09fab4917
S: bace4b2a0bd2088202a2f09a384af632e5dcd230 10.211.55.5:8005
   replicates 996869f6edf22608d407b99726b3b0e80c5ac194
S: dfccd40cfbeabc36f564de2bd0ccf6bc49191af7 10.211.55.4:8004
   replicates 42ae80c2a513b5484088f88611d3aca8988d7528
Can I set the above configuration? (type 'yes' to accept): yes
>>> Nodes configuration updated
>>> Assign a different config epoch to each node
>>> Sending CLUSTER MEET messages to join the cluster
Waiting for the cluster to join
......
>>> Performing Cluster Check (using node 10.211.55.3:8001)
M: 996869f6edf22608d407b99726b3b0e80c5ac194 10.211.55.3:8001
   slots:[0-5460] (5461 slots) master
   1 additional replica(s)
S: bace4b2a0bd2088202a2f09a384af632e5dcd230 10.211.55.5:8005
   slots: (0 slots) slave
   replicates 996869f6edf22608d407b99726b3b0e80c5ac194
M: 7c87165c1753858ee51ca350253e17b09fab4917 10.211.55.4:8003
   slots:[10923-16383] (5461 slots) master
   1 additional replica(s)
M: 42ae80c2a513b5484088f88611d3aca8988d7528 10.211.55.5:8006
   slots:[5461-10922] (5462 slots) master
   1 additional replica(s)
S: dfccd40cfbeabc36f564de2bd0ccf6bc49191af7 10.211.55.4:8004
   slots: (0 slots) slave
   replicates 42ae80c2a513b5484088f88611d3aca8988d7528
S: fde4695b37f216d6fec57acfc3b136c102fc3579 10.211.55.3:8002
   slots: (0 slots) slave
   replicates 7c87165c1753858ee51ca350253e17b09fab4917
[OK] All nodes agree about slots configuration.
>>> Check for open slots...
>>> Check slots coverage...
[OK] All 16384 slots covered.
```
è¾“å‡ºä¸Šè¿°ç»“æœåŸºæœ¬æ˜¯æˆåŠŸäº†ã€‚ä½¿ç”¨ä¸‹é¢å‘½ä»¤éªŒè¯æ˜¯å¦æ­å»ºæˆåŠŸï¼š
```shell
10.211.55.3:8001> cluster nodes

bace4b2a0bd2088202a2f09a384af632e5dcd230 10.211.55.5:8005@18005 slave 996869f6edf22608d407b99726b3b0e80c5ac194 0 1677886398000 5 connected
7c87165c1753858ee51ca350253e17b09fab4917 10.211.55.4:8003@18003 master - 0 1677886397453 3 connected 10923-16383
996869f6edf22608d407b99726b3b0e80c5ac194 10.211.55.3:8001@18001 myself,master - 0 1677886388000 1 connected 0-5460
42ae80c2a513b5484088f88611d3aca8988d7528 10.211.55.5:8006@18006 master - 0 1677886398089 2 connected 5461-10922
dfccd40cfbeabc36f564de2bd0ccf6bc49191af7 10.211.55.4:8004@18004 slave 42ae80c2a513b5484088f88611d3aca8988d7528 0 1677886397000 6 connected
fde4695b37f216d6fec57acfc3b136c102fc3579 10.211.55.3:8002@18002 slave 7c87165c1753858ee51ca350253e17b09fab4917 0 1677886398510 4 connected
```

å¯ä»¥å‘ç° redis å¸®æˆ‘ä»¬å»ºç«‹é›†ç¾¤çš„æ—¶å€™æ˜¯é”™ä½å»ºç«‹ä¸»ä»çš„ï¼Œè¿™æ ·å»ºç«‹ä¸»ä»æ›´å®‰å…¨ã€‚å¦‚æœä¸»ä»èŠ‚ç‚¹éƒ½åœ¨ä¸€å°æœºå™¨ä¸Šï¼Œå½“ä¸»èŠ‚ç‚¹æŒ‚æ‰ï¼Œæ­¤æ—¶è¿™ä¸ªå°é›†ç¾¤å°±æŒ‚æ‰äº†ã€‚
redis-cluster é›†ç¾¤é»˜è®¤å½“ä¸€ä¸ªå°é›†ç¾¤æŒ‚æ‰ï¼Œæ•´ä¸ªredisé›†ç¾¤å°±ä¸ä¼šå¯¹å¤–æä¾›æœåŠ¡äº†ã€‚

é€šè¿‡ä¸Šé¢æ­å»º redis-cluster é›†ç¾¤ï¼Œå‘ç°è¿˜æ˜¯éœ€è¦æ‰‹åŠ¨è¿æ¥å®¢æˆ·ç«¯ï¼Œä»ç„¶å¤„äºåŠè‡ªåŠ¨åŒ–çŠ¶æ€ã€‚é‚£ä¹ˆå¦‚ä½•æ‰‹åŠ¨åœ°å‘é›†ç¾¤ä¸­æ·»åŠ èŠ‚ç‚¹å‘¢ï¼Ÿ
```shell
# ä½¿ç”¨ redis-cli æŸ¥çœ‹é›†ç¾¤å‘½ä»¤
redis-cli --cluster help
# è¾“å‡ºç»“æœ
Cluster Manager Commands:
  create         host1:port1 ... hostN:portN
                 --cluster-replicas <arg>
  check          host:port
                 --cluster-search-multiple-owners
  info           host:port
  fix            host:port
                 --cluster-search-multiple-owners
  reshard        host:port
                 --cluster-from <arg>
                 --cluster-to <arg>
                 --cluster-slots <arg>
                 --cluster-yes
                 --cluster-timeout <arg>
                 --cluster-pipeline <arg>
                 --cluster-replace
  rebalance      host:port
                 --cluster-weight <node1=w1...nodeN=wN>
                 --cluster-use-empty-masters
                 --cluster-timeout <arg>
                 --cluster-simulate
                 --cluster-pipeline <arg>
                 --cluster-threshold <arg>
                 --cluster-replace
  add-node       new_host:new_port existing_host:existing_port
                 --cluster-slave
                 --cluster-master-id <arg>
  del-node       host:port node_id
  call           host:port command arg arg .. arg
  set-timeout    host:port milliseconds
  import         host:port
                 --cluster-from <arg>
                 --cluster-copy
                 --cluster-replace
```
1. create:åˆ›å»ºä¸€ä¸ªé›†ç¾¤ç¯å¢ƒhost1:port1 ... hostN:portN
2. call:å¯ä»¥æ‰§è¡Œrediså‘½ä»¤
3. add-node:å°†ä¸€ä¸ªèŠ‚ç‚¹æ·»åŠ åˆ°é›†ç¾¤é‡Œï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸ºæ–°èŠ‚ç‚¹çš„ip:portï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºé›†ç¾¤ä¸­ä»»æ„ä¸€ä¸ªå·²ç»å­˜åœ¨çš„èŠ‚ç‚¹çš„ip:port
4. del-node:ç§»é™¤ä¸€ä¸ªèŠ‚ç‚¹
5. reshard:é‡æ–°åˆ†ç‰‡
6. check:æ£€æŸ¥é›†ç¾¤çŠ¶æ€

æ·»åŠ èŠ‚ç‚¹éœ€è¦ä¸¤éƒ¨æ“ä½œï¼š
```shell
# ç¬¬ä¸€æ­¥æ·»åŠ èŠ‚ç‚¹(åªä»‹ç»ä¸‹å‘½ä»¤ï¼Œä¸æ“ä½œäº†)
redisâ€cli â€â€cluster addâ€node 10.211.55.3:8007 10.211.55.3:8001
# å°† 8007 æ·»åŠ å®ŒèŠ‚ç‚¹åï¼Œè¿˜éœ€è¦è®©ä¸»èŠ‚ç‚¹é‡æ–°åˆ†é…æ§½ä½
redisâ€cli â€â€cluster reshard 10.211.55.3:8001
```

## ä»£ç éªŒè¯
### Jedis æ“ä½œ
```java
package com.anzhi.clusterjedis.service;

import redis.clients.jedis.HostAndPort;
import redis.clients.jedis.JedisCluster;
import redis.clients.jedis.JedisPoolConfig;

import java.io.IOException;
import java.util.HashSet;
import java.util.Set;

public class JedisClusterDemo {
    public static void main(String[] args) throws IOException {
        JedisPoolConfig config = new JedisPoolConfig();
        config.setMaxTotal(20);
        config.setMaxTotal(20);
        config.setMinIdle(5);

        Set<HostAndPort> jedisClusterNode = new HashSet<HostAndPort>();
        jedisClusterNode.add(new HostAndPort("10.211.55.3", 8001));
        jedisClusterNode.add(new HostAndPort("10.211.55.3", 8002));
        jedisClusterNode.add(new HostAndPort("10.211.55.4", 8003));
        jedisClusterNode.add(new HostAndPort("10.211.55.4", 8004));
        jedisClusterNode.add(new HostAndPort("10.211.55.5", 8005));
        jedisClusterNode.add(new HostAndPort("10.211.55.5", 8006));

        JedisCluster jedisCluster = null;
        try{
            //connectionTimeout:æŒ‡çš„æ˜¯è¿æ¥ä¸€ä¸ªurlçš„è¿æ¥ç­‰å¾…æ—¶é—´
            //soTimeout:æŒ‡çš„æ˜¯è¿æ¥ä¸Šä¸€ä¸ªurlï¼Œè·å–responseçš„è¿”å›ç­‰å¾…æ—¶é—´
            jedisCluster = new JedisCluster(jedisClusterNode, 6000, 5000, 10, config);
            System.out.println(jedisCluster.set("clusterA", "clusterA"));
            System.out.println(jedisCluster.get("clusterA"));
        }catch (Exception e){
            // doNothing
        }finally {
            if (jedisCluster != null) {
                jedisCluster.close();
            }
        }
    }
}
```

## Spring Boot æ“ä½œ
åŸºäºä¹‹å‰å“¨å…µçš„ Spring Boot å·¥ç¨‹æ”¹é€ 
pom.xml ä¾èµ–å‚è€ƒå“¨å…µã€‚

yml é…ç½®
```yaml
server:
  port: 8080
  
spring:
  redis:
    database: 0
    timeout: 3000
    # å“¨å…µæ¨¡å¼é…ç½®
#    sentinel:
#      master: mymaster
#      nodes: 10.211.55.3:26379,10.211.55.4:26380,10.211.55.5:26381
#    lettuce:
#      pool:
#        max-idle: 50
#        min-idle: 10
#        max-active: 100
#        max-wait: 1000
    # redis-cluster é›†ç¾¤æ¨¡å¼é…ç½®
    cluster:
      nodes: 10.211.55.3:8001 10.211.55.5:8006 10.211.55.4:8003 10.211.55.3:8002 10.211.55.5:8005 10.211.55.4:8004
    lettuce:
      pool:
        max-idle: 50
        min-idle: 10
        max-active: 100
        max-wait: 1000
```

controller å±‚è®¿é—®ä»£ç 
```java
@RestController
public class RedisClusterController {
    private static final Logger logger = LoggerFactory.getLogger(RedisClusterController.class);

    @Autowired
    private StringRedisTemplate stringRedisTemplate;

    @RequestMapping("/rediscluster")
    public String testCluster() throws InterruptedException {
        stringRedisTemplate.opsForValue().set("clusterA", "clusterA");
        System.out.println(stringRedisTemplate.opsForValue().get("clusterA"));
        return stringRedisTemplate.opsForValue().get("clusterA");
    }
}
```
åˆ›å»ºå¯åŠ¨ç±»ï¼Œ
```java
@SpringBootApplication
public class RedisClusterApplication {
    public static void main(String[] args) {
        SpringApplication.run(RedisClusterApplication.class, args);
    }
}
```
é€šè¿‡è¿æ¥è®¿é—®ï¼šhttp://localhost:8080/rediscluster

# Redis Cluster é›†ç¾¤åŸç†
ä¸Šé¢æˆ‘ä»¬åœ¨é…ç½® Redis é›†ç¾¤çš„æ—¶å€™ã€‚æœ€åè¾“å‡ºäº†è¿™æ ·ä¸€ä¸ªä¿¡æ¯ï¼š`[OK] All 16384 slots covered.`ã€‚ redis-cluster å°†æ‰€æœ‰æ•°æ®åˆ’åˆ†ä¸º 16384 ä¸ª
slots(æ§½ä½)ï¼Œæ¯ä¸ªèŠ‚ç‚¹è´Ÿè´£å…¶ä¸­ä¸€éƒ¨åˆ†æ§½ä½ã€‚æ§½ä½çš„ä¿¡æ¯å­˜å‚¨äºæ¯ä¸ªèŠ‚ç‚¹ä¸­ã€‚

## æ§½æŒ‡æ´¾æœºåˆ¶
å½“æ–°çš„èŠ‚ç‚¹åŠ å…¥é›†ç¾¤çš„æ—¶å€™ï¼ŒåŒæ ·ä¼šå¾—åˆ°ä¸€ä»½é›†ç¾¤çš„æ§½ä½é…ç½®ä¿¡æ¯å¹¶å°†å…¶ç¼“å­˜åœ¨å®¢æˆ·ç«¯æœ¬åœ°ã€‚è¿™ä¸ªä¿¡æ¯å°±æ˜¯æˆ‘ä»¬åœ¨ conf é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šçš„`cluster-config-file nodes-8006.conf`ã€‚

å½“ Redis Cluster çš„å®¢æˆ·ç«¯æ¥è¿æ¥é›†ç¾¤æ—¶ï¼Œå®ƒä¹Ÿä¼šå¾—åˆ°ä¸€ä»½é›†ç¾¤çš„æ§½ä½é…ç½®ä¿¡æ¯å¹¶å°†å…¶ç¼“å­˜åœ¨å®¢æˆ·ç«¯æœ¬åœ°ã€‚è¿™æ ·å½“å®¢æˆ·ç«¯è¦æŸ¥æ‰¾æŸä¸ª key æ—¶ï¼Œå¯ä»¥ç›´æ¥
å®šä½åˆ°ç›®æ ‡èŠ‚ç‚¹ã€‚åŒæ—¶å› ä¸ºæ§½ä½çš„ä¿¡æ¯å¯èƒ½ä¼šå­˜åœ¨å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ä¸ä¸€è‡´çš„æƒ…å†µï¼Œè¿˜éœ€è¦çº æ­£æœºåˆ¶æ¥å®ç°æ§½ä½ä¿¡æ¯çš„æ ¡éªŒè°ƒæ•´ã€‚

## æ§½å®šä½ç®—æ³•
Cluster é»˜è®¤ä¼šå¯¹ key å€¼ä½¿ç”¨ crc16 ç®—æ³•è¿›è¡Œ hash å¾—åˆ°ä¸€ä¸ªæ•´æ•°å€¼ï¼Œç„¶åç”¨è¿™ä¸ªæ•´æ•°å€¼å¯¹ 16384 è¿›è¡Œå–æ¨¡ æ¥å¾—åˆ°å…·ä½“æ§½ä½ã€‚

HASH_SLOT = CRC16(key) mod 16384

## è·³è½¬é‡å®šä½
å½“å®¢æˆ·ç«¯å‘ä¸€ä¸ªé”™è¯¯çš„èŠ‚ç‚¹å‘å‡ºäº†æŒ‡ä»¤ï¼Œè¯¥èŠ‚ç‚¹ä¼šå‘ç°æŒ‡ä»¤çš„ key æ‰€åœ¨çš„æ§½ä½å¹¶ä¸å½’è‡ªå·±ç®¡ç†ï¼Œè¿™æ—¶å®ƒä¼šå‘å®¢ æˆ·ç«¯å‘é€ä¸€ä¸ªç‰¹æ®Šçš„è·³è½¬æŒ‡ä»¤æºå¸¦ç›®æ ‡æ“ä½œ
çš„èŠ‚ç‚¹åœ°å€ï¼Œå‘Šè¯‰å®¢æˆ·ç«¯å»è¿è¿™ä¸ªèŠ‚ç‚¹å»è·å–æ•°æ®ã€‚å®¢æˆ·ç«¯æ”¶åˆ°æŒ‡ ä»¤åé™¤äº†è·³è½¬åˆ°æ­£ç¡®çš„èŠ‚ç‚¹ä¸Šå»æ“ä½œï¼Œè¿˜ä¼šåŒæ­¥æ›´æ–°çº æ­£æœ¬åœ°çš„æ§½ä½æ˜ å°„è¡¨ç¼“å­˜ï¼Œåç»­æ‰€
æœ‰ key å°†ä½¿ç”¨æ–°çš„æ§½ä½æ˜ å°„è¡¨ã€‚

## Redis é›†ç¾¤èŠ‚ç‚¹é—´çš„é€šä¿¡æœºåˆ¶
redis cluster èŠ‚ç‚¹é—´é‡‡å– gossip åè®®è¿›è¡Œé€šä¿¡ã€‚

ç»´æŠ¤é›†ç¾¤çš„å…ƒæ•°æ®(é›†ç¾¤èŠ‚ç‚¹ä¿¡æ¯ï¼Œä¸»ä»è§’è‰²ï¼ŒèŠ‚ç‚¹æ•°é‡ï¼Œå„èŠ‚ç‚¹å…±äº«çš„æ•°æ®ç­‰)æœ‰ä¸¤ç§æ–¹å¼:é›†ä¸­
å¼å’Œgossip

1. é›†ä¸­å¼ï¼šä¼˜ç‚¹åœ¨äºå…ƒæ•°æ®çš„æ›´æ–°å’Œè¯»å–ï¼Œæ—¶æ•ˆæ€§éå¸¸å¥½ï¼Œä¸€æ—¦å…ƒæ•°æ®å‡ºç°å˜æ›´ç«‹å³å°±ä¼šæ›´æ–°åˆ°é›†ä¸­å¼çš„å­˜å‚¨ä¸­ï¼Œå…¶ä»–èŠ‚ç‚¹è¯»å–çš„æ—¶å€™ç«‹å³å°±å¯ä»¥ç«‹å³æ„Ÿ
çŸ¥åˆ°;ä¸è¶³åœ¨äºæ‰€æœ‰çš„å…ƒæ•°æ®çš„æ›´æ–°å‹åŠ›å…¨éƒ¨é›†ä¸­åœ¨ä¸€ä¸ªåœ°æ–¹ï¼Œå¯èƒ½å¯¼è‡´å…ƒæ•°æ®çš„å­˜å‚¨å‹åŠ›ã€‚å¾ˆå¤šä¸­é—´ä»¶éƒ½ä¼šå€ŸåŠ©zookeeperé›†ä¸­å¼å­˜å‚¨å…ƒæ•°æ®ã€‚
2. gossipï¼šåè®®åŒ…å«å¤šç§æ¶ˆæ¯ï¼ŒåŒ…æ‹¬pingï¼Œpongï¼Œmeetï¼Œfailç­‰ç­‰ã€‚
   1. meet:æŸä¸ªèŠ‚ç‚¹å‘é€meetç»™æ–°åŠ å…¥çš„èŠ‚ç‚¹ï¼Œè®©æ–°èŠ‚ç‚¹åŠ å…¥é›†ç¾¤ä¸­ï¼Œç„¶åæ–°èŠ‚ç‚¹å°±ä¼šå¼€å§‹ä¸å…¶ä»–èŠ‚ç‚¹è¿›è¡Œé€šä¿¡;
   2. ping:æ¯ä¸ªèŠ‚ç‚¹éƒ½ä¼šé¢‘ç¹ç»™å…¶ä»–èŠ‚ç‚¹å‘é€pingï¼Œå…¶ä¸­åŒ…å«è‡ªå·±çš„çŠ¶æ€è¿˜æœ‰è‡ªå·±ç»´æŠ¤çš„é›†ç¾¤å…ƒæ•°æ®ï¼Œäº’ç›¸é€šè¿‡ pingäº¤æ¢å…ƒæ•°æ®(ç±»ä¼¼è‡ªå·±æ„ŸçŸ¥åˆ°çš„é›†
   ç¾¤èŠ‚ç‚¹å¢åŠ å’Œç§»é™¤ï¼Œhash slotä¿¡æ¯ç­‰);
   3. pong: å¯¹pingå’Œmeetæ¶ˆæ¯çš„è¿”å›ï¼ŒåŒ…å«è‡ªå·±çš„çŠ¶æ€å’Œå…¶ä»–ä¿¡æ¯ï¼Œä¹Ÿå¯ä»¥ç”¨äºä¿¡æ¯å¹¿æ’­å’Œæ›´æ–°;
   4. fail: æŸä¸ªèŠ‚ç‚¹åˆ¤æ–­å¦ä¸€ä¸ªèŠ‚ç‚¹failä¹‹åï¼Œå°±å‘é€failç»™å…¶ä»–èŠ‚ç‚¹ï¼Œé€šçŸ¥å…¶ä»–èŠ‚ç‚¹ï¼ŒæŒ‡å®šçš„èŠ‚ç‚¹å®•æœºäº†ã€‚

gossipåè®®çš„ä¼˜ç‚¹åœ¨äºå…ƒæ•°æ®çš„æ›´æ–°æ¯”è¾ƒåˆ†æ•£ï¼Œä¸æ˜¯é›†ä¸­åœ¨ä¸€ä¸ªåœ°æ–¹ï¼Œæ›´æ–°è¯·æ±‚ä¼šé™†é™†ç»­ç»­ï¼Œæ‰“åˆ°æ‰€æœ‰èŠ‚ç‚¹ä¸Šå»æ›´æ–°ï¼Œæœ‰ä¸€å®šçš„å»¶æ—¶ï¼Œé™ä½äº†å‹åŠ›;ç¼ºç‚¹åœ¨
äºå…ƒæ•°æ®æ›´æ–°æœ‰å»¶æ—¶å¯èƒ½å¯¼è‡´é›†ç¾¤çš„ä¸€äº›æ“ä½œä¼šæœ‰ä¸€äº›æ»åã€‚

## gossipé€šä¿¡çš„10000ç«¯å£
æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰ä¸€ä¸ªä¸“é—¨ç”¨äºèŠ‚ç‚¹é—´gossipé€šä¿¡çš„ç«¯å£ï¼Œå°±æ˜¯è‡ªå·±æä¾›æœåŠ¡çš„ç«¯å£å·+10000ï¼Œæ¯”å¦‚7001ï¼Œé‚£ä¹ˆ ç”¨äºèŠ‚ç‚¹é—´é€šä¿¡çš„å°±æ˜¯17001ç«¯å£ã€‚ æ¯ä¸ªèŠ‚
ç‚¹æ¯éš”ä¸€æ®µæ—¶é—´éƒ½ä¼šå¾€å¦å¤–å‡ ä¸ªèŠ‚ç‚¹å‘é€pingæ¶ˆæ¯ï¼ŒåŒæ—¶å…¶ä»–å‡ ç‚¹æ¥æ”¶åˆ°pingæ¶ˆæ¯ä¹‹åè¿”å›pongæ¶ˆæ¯ã€‚

## ç½‘ç»œæŠ–åŠ¨
çœŸå®ä¸–ç•Œçš„æœºæˆ¿ç½‘ç»œå¾€å¾€å¹¶ä¸æ˜¯é£å¹³æµªé™çš„ï¼Œå®ƒä»¬ç»å¸¸ä¼šå‘ç”Ÿå„ç§å„æ ·çš„å°é—®é¢˜ã€‚æ¯”å¦‚ç½‘ç»œæŠ–åŠ¨å°±æ˜¯éå¸¸å¸¸è§ çš„ä¸€ç§ç°è±¡ï¼Œçªç„¶ä¹‹é—´éƒ¨åˆ†è¿æ¥å˜å¾—ä¸å¯è®¿é—®ï¼Œ
ç„¶åå¾ˆå¿«åˆæ¢å¤æ­£å¸¸ã€‚ ä¸ºè§£å†³è¿™ç§é—®é¢˜ï¼ŒRedis Cluster æä¾›äº†ä¸€ç§é€‰é¡¹cluster-node-timeoutï¼Œè¡¨ç¤ºå½“æŸä¸ªèŠ‚ç‚¹æŒç»­ timeout çš„æ—¶é—´å¤±è”æ—¶ï¼Œæ‰
å¯ä»¥è®¤å®šè¯¥èŠ‚ç‚¹å‡ºç°æ•…éšœï¼Œéœ€è¦è¿›è¡Œä¸»ä»åˆ‡æ¢ã€‚å¦‚æœæ²¡æœ‰è¿™ä¸ªé€‰é¡¹ï¼Œç½‘ç»œæŠ–åŠ¨ä¼šå¯¼è‡´ä¸»ä»é¢‘ç¹åˆ‡æ¢ (æ•°æ®çš„é‡æ–°å¤åˆ¶)ã€‚
## Redisé›†ç¾¤é€‰ä¸¾åŸç†åˆ†æ
å½“slaveå‘ç°è‡ªå·±çš„masterå˜ä¸ºFAILçŠ¶æ€æ—¶ï¼Œä¾¿å°è¯•è¿›è¡ŒFailoverï¼Œä»¥æœŸæˆä¸ºæ–°çš„masterã€‚ç”±äºæŒ‚æ‰çš„ master å¯èƒ½ä¼šæœ‰å¤šä¸ªslaveï¼Œä»è€Œå­˜åœ¨å¤šä¸ª
slaveç«äº‰æˆä¸ºmasterèŠ‚ç‚¹çš„è¿‡ç¨‹ï¼Œ å…¶è¿‡ç¨‹å¦‚ä¸‹: 
1. slaveå‘ç°è‡ªå·±çš„masterå˜ä¸ºFAIL 
2. å°†è‡ªå·±è®°å½•çš„é›†ç¾¤currentEpochåŠ 1ï¼Œå¹¶å¹¿æ’­ FAILOVER_AUTH_REQUEST ä¿¡æ¯
3. å…¶ä»–èŠ‚ç‚¹æ”¶åˆ°è¯¥ä¿¡æ¯ï¼Œåªæœ‰masterå“åº”ï¼Œåˆ¤æ–­è¯·æ±‚è€…çš„åˆæ³•æ€§ï¼Œå¹¶å‘é€ FAILOVER_AUTH_ACKï¼Œå¯¹æ¯ä¸€ä¸ª epoch åªå‘é€ä¸€æ¬¡ ack
4. å°è¯• failoverçš„ slave æ”¶é›† master è¿”å›çš„ FAILOVER_AUTH_ACK 
5. slave æ”¶åˆ°è¶…è¿‡åŠæ•° master çš„ ack åå˜æˆæ–° Master(è¿™é‡Œè§£é‡Šäº†é›†ç¾¤ä¸ºä»€ä¹ˆè‡³å°‘éœ€è¦ä¸‰ä¸ªä¸»èŠ‚ç‚¹ï¼Œå¦‚æœåªæœ‰ä¸¤ ä¸ªï¼Œå½“å…¶ä¸­ä¸€ä¸ªæŒ‚äº†ï¼Œåªå‰©ä¸€ä¸ªä¸»èŠ‚ç‚¹æ˜¯ä¸èƒ½é€‰ä¸¾æˆåŠŸçš„)
6. slaveå¹¿æ’­Pongæ¶ˆæ¯é€šçŸ¥å…¶ä»–é›†ç¾¤èŠ‚ç‚¹ã€‚
7. 
ä»èŠ‚ç‚¹å¹¶ä¸æ˜¯åœ¨ä¸»èŠ‚ç‚¹ä¸€è¿›å…¥ FAIL çŠ¶æ€å°±é©¬ä¸Šå°è¯•å‘èµ·é€‰ä¸¾ï¼Œè€Œæ˜¯æœ‰ä¸€å®šå»¶è¿Ÿï¼Œä¸€å®šçš„å»¶è¿Ÿç¡®ä¿æˆ‘ä»¬ç­‰å¾… FAIL çŠ¶æ€åœ¨é›†ç¾¤ä¸­ä¼ æ’­ï¼Œslave å¦‚æœç«‹å³å°è¯•é€‰ä¸¾ï¼Œ
å…¶å®ƒ masters æˆ–è®¸å°šæœªæ„è¯†åˆ° FAIL çŠ¶æ€ï¼Œå¯èƒ½ä¼šæ‹’ç»æŠ•ç¥¨ 

å»¶è¿Ÿè®¡ç®—å…¬å¼:

DELAY = 500ms + random(0 ~ 500ms) + SLAVE_RANK * 1000ms

SLAVE_RANK è¡¨ç¤ºæ­¤ slave å·²ç»ä» master å¤åˆ¶æ•°æ®çš„æ€»é‡çš„ rankã€‚Rankè¶Šå°ä»£è¡¨å·²å¤åˆ¶çš„æ•°æ®è¶Šæ–°ã€‚è¿™ç§æ–¹å¼ä¸‹ï¼ŒæŒæœ‰æœ€æ–°æ•°æ®çš„ slave å°†ä¼šé¦–å…ˆ
å‘èµ·é€‰ä¸¾(ç†è®ºä¸Š)ã€‚

## é›†ç¾¤è„‘è£‚æ•°æ®ä¸¢å¤±é—®é¢˜
redisé›†ç¾¤æ²¡æœ‰è¿‡åŠæœºåˆ¶ä¼šæœ‰è„‘è£‚é—®é¢˜ï¼Œç½‘ç»œåˆ†åŒºå¯¼è‡´è„‘è£‚åå¤šä¸ªä¸»èŠ‚ç‚¹å¯¹å¤–æä¾›å†™æœåŠ¡ï¼Œä¸€æ—¦ç½‘ç»œåˆ†åŒºæ¢å¤ï¼Œä¼šå°†å…¶ä¸­ä¸€ä¸ªä¸»èŠ‚ç‚¹å˜ä¸ºä»èŠ‚ç‚¹ï¼Œè¿™æ—¶ä¼šæœ‰
å¤§é‡æ•°æ®ä¸¢å¤±ã€‚

è§„é¿æ–¹æ³•å¯ä»¥åœ¨redisé…ç½®é‡ŒåŠ ä¸Šå‚æ•°(è¿™ç§æ–¹æ³•ä¸å¯èƒ½ç™¾åˆ†ç™¾é¿å…æ•°æ®ä¸¢å¤±ï¼Œå‚è€ƒé›†ç¾¤leaderé€‰ä¸¾æœºåˆ¶):

`minâ€replicasâ€toâ€write 1` //å†™æ•°æ®æˆåŠŸæœ€å°‘åŒæ­¥çš„slaveæ•°é‡ï¼Œè¿™ä¸ªæ•°é‡å¯ä»¥æ¨¡ä»¿å¤§äºåŠæ•°æœºåˆ¶é…ç½®ï¼Œæ¯”å¦‚é›†ç¾¤æ€»å…±ä¸‰ä¸ªèŠ‚ç‚¹å¯ä»¥é…ç½®1ï¼ŒåŠ ä¸Šleader
å°±æ˜¯2ï¼Œè¶…è¿‡äº†åŠæ•°ã€‚

æ³¨æ„:è¿™ä¸ªé…ç½®åœ¨ä¸€å®šç¨‹åº¦ä¸Šä¼šå½±å“é›†ç¾¤çš„å¯ç”¨æ€§ï¼Œæ¯”å¦‚slaveè¦æ˜¯å°‘äº1ä¸ªï¼Œè¿™ä¸ªé›†ç¾¤å°±ç®—leaderæ­£å¸¸ä¹Ÿä¸èƒ½ æä¾›æœåŠ¡äº†ï¼Œéœ€è¦å…·ä½“åœºæ™¯æƒè¡¡é€‰æ‹©ã€‚

## é›†ç¾¤æ˜¯å¦å®Œæ•´æ‰èƒ½å¯¹å¤–æä¾›æœåŠ¡
å½“redis.confçš„é…ç½®`cluster-require-full-coverage` ä¸º no æ—¶ï¼Œè¡¨ç¤ºå½“è´Ÿè´£ä¸€ä¸ªæ’æ§½çš„ä¸»åº“ä¸‹çº¿ä¸”æ²¡æœ‰ç›¸åº”çš„ä» åº“è¿›è¡Œæ•…éšœæ¢å¤æ—¶ï¼Œé›†ç¾¤ä»ç„¶å¯ç”¨ï¼Œ
å¦‚æœä¸ºyesåˆ™é›†ç¾¤ä¸å¯ç”¨ã€‚

## Redisé›†ç¾¤ä¸ºä»€ä¹ˆè‡³å°‘éœ€è¦ä¸‰ä¸ªmasterèŠ‚ç‚¹ï¼Œå¹¶ä¸”æ¨èèŠ‚ç‚¹æ•°ä¸ºå¥‡æ•°?
å› ä¸ºæ–°masterçš„é€‰ä¸¾éœ€è¦å¤§äºåŠæ•°çš„é›†ç¾¤masterèŠ‚ç‚¹åŒæ„æ‰èƒ½é€‰ä¸¾æˆåŠŸï¼Œå¦‚æœåªæœ‰ä¸¤ä¸ªmasterèŠ‚ç‚¹ï¼Œå½“å…¶ä¸­ ä¸€ä¸ªæŒ‚äº†ï¼Œæ˜¯è¾¾ä¸åˆ°é€‰ä¸¾æ–°masterçš„æ¡ä»¶çš„ã€‚
å¥‡æ•°ä¸ªmasterèŠ‚ç‚¹å¯ä»¥åœ¨æ»¡è¶³é€‰ä¸¾è¯¥æ¡ä»¶çš„åŸºç¡€ä¸ŠèŠ‚çœä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ¯”å¦‚ä¸‰ä¸ªmasterèŠ‚ç‚¹å’Œå››ä¸ªmasterèŠ‚ç‚¹çš„ é›†ç¾¤ç›¸æ¯”ï¼Œå¤§å®¶å¦‚æœéƒ½æŒ‚äº†ä¸€ä¸ªmasterèŠ‚ç‚¹
éƒ½èƒ½é€‰ä¸¾æ–°masterèŠ‚ç‚¹ï¼Œå¦‚æœéƒ½æŒ‚äº†ä¸¤ä¸ªmasterèŠ‚ç‚¹éƒ½æ²¡æ³•é€‰ä¸¾ æ–°masterèŠ‚ç‚¹äº†ï¼Œæ‰€ä»¥å¥‡æ•°çš„masterèŠ‚ç‚¹æ›´å¤šçš„æ˜¯ä»èŠ‚çœæœºå™¨èµ„æºè§’åº¦å‡ºå‘è¯´çš„ã€‚
## Redisé›†ç¾¤å¯¹æ‰¹é‡æ“ä½œå‘½ä»¤çš„æ”¯æŒ
å¯¹äºç±»ä¼¼msetï¼Œmgetè¿™æ ·çš„å¤šä¸ªkeyçš„åŸç”Ÿæ‰¹é‡æ“ä½œå‘½ä»¤ï¼Œredisé›†ç¾¤åªæ”¯æŒæ‰€æœ‰keyè½åœ¨åŒä¸€slotçš„æƒ…å†µï¼Œå¦‚ æœæœ‰å¤šä¸ªkeyä¸€å®šè¦ç”¨msetå‘½ä»¤åœ¨redisé›†
ç¾¤ä¸Šæ“ä½œï¼Œåˆ™å¯ä»¥åœ¨keyçš„å‰é¢åŠ ä¸Š{XX}ï¼Œè¿™æ ·å‚æ•°æ•°æ®åˆ†ç‰‡hashè®¡ ç®—çš„åªä¼šæ˜¯å¤§æ‹¬å·é‡Œçš„å€¼ï¼Œè¿™æ ·èƒ½ç¡®ä¿ä¸åŒçš„keyèƒ½è½åˆ°åŒä¸€sloté‡Œå»ï¼Œç¤ºä¾‹å¦‚ä¸‹:

å‡è®¾nameå’Œageè®¡ç®—çš„hash slotå€¼ä¸ä¸€æ ·ï¼Œä½†æ˜¯è¿™æ¡å‘½ä»¤åœ¨é›†ç¾¤ä¸‹æ‰§è¡Œï¼Œredisåªä¼šç”¨å¤§æ‹¬å·é‡Œçš„ user1 åš hash slotè®¡ç®—ï¼Œæ‰€ä»¥ç®—å‡ºæ¥çš„slotå€¼è‚¯
å®šç›¸åŒï¼Œæœ€åéƒ½èƒ½è½åœ¨åŒä¸€slotã€‚

## å“¨å…µleaderé€‰ä¸¾æµç¨‹
å½“ä¸€ä¸ªmasteræœåŠ¡å™¨è¢«æŸsentinelè§†ä¸ºä¸‹çº¿çŠ¶æ€åï¼Œè¯¥sentinelä¼šä¸å…¶ä»–sentinelåå•†é€‰å‡ºsentinelçš„leaderè¿› è¡Œæ•…éšœè½¬ç§»å·¥ä½œã€‚æ¯ä¸ªå‘ç°master
æœåŠ¡å™¨è¿›å…¥ä¸‹çº¿çš„sentineléƒ½å¯ä»¥è¦æ±‚å…¶ä»–sentinelé€‰è‡ªå·±ä¸ºsentinelçš„ leaderï¼Œé€‰ä¸¾æ˜¯å…ˆåˆ°å…ˆå¾—ã€‚åŒæ—¶æ¯ä¸ªsentinelæ¯æ¬¡é€‰ä¸¾éƒ½ä¼šè‡ªå¢é…ç½®çºªå…ƒ
(é€‰ä¸¾å‘¨æœŸ)ï¼Œæ¯ä¸ªçºªå…ƒä¸­åªä¼šé€‰æ‹©ä¸€ ä¸ªsentinelçš„leaderã€‚å¦‚æœæ‰€æœ‰è¶…è¿‡ä¸€åŠçš„sentinelé€‰ä¸¾æŸsentinelä½œä¸ºleaderã€‚ä¹‹åè¯¥sentinelè¿›è¡Œæ•…éšœè½¬ç§»
æ“ä½œï¼Œä»å­˜æ´»çš„slaveä¸­é€‰ä¸¾å‡ºæ–°çš„masterï¼Œè¿™ä¸ªé€‰ä¸¾è¿‡ç¨‹è·Ÿé›†ç¾¤çš„masteré€‰ä¸¾å¾ˆç±»ä¼¼ã€‚ å“¨å…µé›†ç¾¤åªæœ‰ä¸€ä¸ªå“¨å…µèŠ‚ç‚¹ï¼Œredisçš„ä¸»ä»ä¹Ÿèƒ½æ­£å¸¸è¿è¡Œä»¥åŠé€‰
ä¸¾masterï¼Œå¦‚æœmasteræŒ‚äº†ï¼Œé‚£å”¯ä¸€çš„é‚£ä¸ªå“¨ å…µèŠ‚ç‚¹å°±æ˜¯å“¨å…µleaderäº†ï¼Œå¯ä»¥æ­£å¸¸é€‰ä¸¾æ–°masterã€‚ ä¸è¿‡ä¸ºäº†é«˜å¯ç”¨ä¸€èˆ¬éƒ½æ¨èè‡³å°‘éƒ¨ç½²ä¸‰ä¸ªå“¨å…µèŠ‚ç‚¹ã€‚
ä¸ºä»€ä¹ˆæ¨èå¥‡æ•°ä¸ªå“¨å…µèŠ‚ç‚¹åŸç†è·Ÿé›†ç¾¤å¥‡æ•°ä¸ªmasterèŠ‚ç‚¹ç±»ä¼¼ã€‚

