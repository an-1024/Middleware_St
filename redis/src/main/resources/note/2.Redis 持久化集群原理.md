# Redis å•çº¿ç¨‹å’Œé«˜æ€§èƒ½
é€šå¸¸è®² redis å•çº¿ç¨‹æŒ‡çš„æ˜¯ Redis çš„ç½‘ç»œ I/O å’ŒæŒ‡ä»¤è¯»å†™æ˜¯ç”±ä¸€ä¸ªçº¿ç¨‹å®Œæˆçš„ï¼Œè‡³äºå…¶ä»–çš„ä»»åŠ¡ï¼Œæ¯”å¦‚æŒä¹…åŒ–ã€æ•°æ®åŒæ­¥ç­‰å°±æ˜¯å¼‚æ­¥å®Œæˆçš„ï¼›

è™½ç„¶ç½‘ç»œ I/O å’ŒæŒ‡ä»¤è¯»å†™æ˜¯å•çº¿ç¨‹ï¼Œä½†æ˜¯ Redis æ˜¯åœ¨å†…å­˜ä¸­å·¥ä½œï¼Œå› æ­¤å³ä½¿æ˜¯å•çº¿ç¨‹ï¼Œæ‰§è¡Œæ•ˆç‡ä¹Ÿæ˜¯å¾ˆé«˜çš„ï¼›å…¶æ¬¡ï¼ŒRedis I/O æ¨¡å‹é‡‡ç”¨ epoll æ¥å®ç°
å¤šè·¯å¤ç”¨ï¼Œè¿™ä¹Ÿæ˜¯ Redis èƒ½å¤„ç†é‚£ä¹ˆå¤šå¹¶å‘å®¢æˆ·è¿æ¥çš„åŸå› ï¼›(I/O æ¨¡å‹è¯¦è§ NIO ç« èŠ‚[NIO](https://github.com/an-1024/Middleware_St/blob/master/nio/src/main/resources/note/1.NIOBIO.md))

# Redis æŒä¹…åŒ–
åˆšæ‰ä¹Ÿæåˆ°è¿‡ï¼ŒRedis æ˜¯å·¥ä½œåœ¨å†…å­˜ä¸­çš„ï¼Œæ‰€æœ‰çš„æ•°æ®ä¹Ÿåœ¨å†…å­˜ä¸­ã€‚æ‰€ä»¥ä¸€æ—¦æœåŠ¡å™¨å®•æœºï¼ŒRedis ç¼“å­˜çš„æ•°æ®å°±ä¼šå…¨éƒ¨ä¸¢å¤±ã€‚å› æ­¤ Redis é’ˆå¯¹äºè¿™ç§æƒ…å†µå®ç°
äº†ä¸¤ç§æŒä¹…åŒ–æœºåˆ¶ï¼šRDB(å¿«ç…§ï¼šå…¨é‡å¤‡ä»½)ã€AOF(å¢é‡å¤‡ä»½)ã€‚
## RDB å¿«ç…§
åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼ŒRedis å°†å†…å­˜æ•°æ®å¿«ç…§ä¿å­˜åœ¨åä¸º dump.rdb æ–‡ä»¶ä¸­ã€‚å¯ä»¥é€šè¿‡ä¿®æ”¹ redis.conf æ–‡ä»¶å‚æ•° `save` æ¥è®¾ç½®å¤šé•¿æ—¶é—´å†…ï¼Œä¿®æ”¹å¤šå°‘æ¬¡è¿›è¡Œä¸€æ¬¡
ä¿å­˜ã€‚å¦‚`save 60 1000`ï¼Œ60ç§’å†…è‡³å°‘æœ‰1000ä¸ªé”®è¢«ä¿®æ”¹ï¼Œå°±ä¼šè‡ªåŠ¨ä¿å­˜ä¸€æ¬¡ã€‚

1. æ•°æ®ä¸¢å¤±é—®é¢˜ï¼šè¿™ä¸ªä¿å­˜å¾ˆæ˜æ˜¾ä¼šæš´éœ²å‡ºä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯åœ¨è¾¾åˆ°è¿™ä¸ªè§¦å‘èŠ‚ç‚¹çš„æ—¶å€™ï¼ŒRedis å®•æœºï¼Œæ•°æ®å°±ä¼šä¸¢å¤±ã€‚
2. æ—¶ç‚¹æ€§é—®é¢˜ï¼šå†™å…¥æ•°æ®éœ€è¦æ—¶é—´ï¼Œæ¯”å¦‚ 8ç‚¹å¼€å§‹å†™å…¥æ•°æ®ï¼Œéœ€è¦4så†™å…¥ï¼Œé‚£ä¹ˆæœ€ç»ˆå­˜å…¥ç£ç›˜çš„æ•°æ®æ˜¯å“ªä¸€åˆ»çš„å‘¢ï¼Ÿ
3. æ•ˆç‡é—®é¢˜ï¼šåœ¨æœåŠ¡çº¿ä¸Šè¯·æ±‚çš„åŒæ—¶ï¼ŒRedis è¿˜éœ€è¦è¿›è¡Œå†…å­˜å¿«ç…§ï¼Œå†…å­˜å¿«ç…§è¦æ±‚ Redis å¿…é¡»è¿›è¡Œæ–‡ ä»¶ IO æ“ä½œï¼Œå¯æ–‡ä»¶ IO æ“ä½œæ˜¯ä¸èƒ½ä½¿ç”¨å¤šè·¯å¤ç”¨ APIã€‚

å…ˆæ¥è°ˆè°ˆ 2ã€3 é—®é¢˜ã€‚Redis ä¸ºäº†è§£å†³è¿™æ ·çš„é—®é¢˜ï¼Œé‡‡ç”¨æ“ä½œç³»ç»Ÿçš„å†™æ—¶å¤åˆ¶æŠ€æœ¯(Copy-On-Write,COW)ï¼Œå°±æ˜¯ä»çˆ¶è¿›ç¨‹ä¸­ fork ä¸€ä¸ªå­è¿›ç¨‹ï¼Œå­è¿›ç¨‹å®Œå…¨å¯ä»¥å…±äº«
çˆ¶è¿›ç¨‹çš„æ•°æ®ï¼Œå¦‚æœçˆ¶è¿›ç¨‹æ˜¯å¯¹æ•°æ®è¿›è¡Œè¯»æ“ä½œï¼Œå¯¹äºå­è¿›ç¨‹æ²¡æœ‰å½±å“ï¼Œç›´æ¥å‘ç£ç›˜å†™å…¥æ•°æ®ã€‚å¦‚æœæ˜¯å†™æ“ä½œï¼Œé‚£ä¹ˆçˆ¶è¿›ç¨‹ä¼šå°†é‚£ä¸€åˆ»çš„æ•°æ®å¤åˆ¶å‡ºä¸€ä»½å‡ºæ¥ï¼Œç„¶ååœ¨æ–°çš„
æ•°æ®ä¸Šè¿›è¡Œä¿®æ”¹ï¼Œè€Œå­è¿›ç¨‹å†™å…¥çš„æ•°æ®è¿˜æ˜¯æ“ä½œæ•°æ®ä¹‹å‰é‚£ä¸€åˆ»çš„æ•°æ®ã€‚å› æ­¤é—®é¢˜ 2 ä¸­å†™å…¥çš„æ•°æ®æ˜¯ fork å­è¿›ç¨‹é‚£ä¸€åˆ»çš„ã€‚

## AOF(å¢é‡å¤‡ä»½)
AOF å°±æ˜¯ä¸ºäº†è§£å†³ RDB æ•°æ®ä¸¢å¤±çš„é—®é¢˜ã€‚AOF ä¼šå°†ä¿®æ”¹çš„æ¯ä¸€æ¡æŒ‡ä»¤è®°å½•è¿›æ–‡ä»¶appendonly.aofä¸­(å…ˆå†™å…¥os cacheï¼Œæ¯éš”ä¸€æ®µæ—¶é—´ fsyncåˆ°ç£ç›˜)ã€‚å¯ä»¥
é€šè¿‡å‚æ•°`# appendonly yes` è¿›è¡Œæ§åˆ¶ã€‚æ‰“å¼€è¿™ä¸ªæœºåˆ¶åï¼Œæ¯å½“ redis ä¿®æ”¹ä¸€ä¸ªæ•°æ®é›†ï¼Œè¿™ä¸ªå‘½ä»¤å°±ä¼šè¢«è¿½åŠ åˆ°è¿™ä¸ªæ–‡ä»¶çš„æœ«å°¾ã€‚è¿™æ ·å³ä½¿ redis å®•æœºï¼Œ
ä¹Ÿå¯ä»¥é€šè¿‡ aof æ–‡ä»¶è¿›è¡Œæ•°æ®æ¢å¤ã€‚åŒæ · redis ä¹Ÿæä¾›äº†é…ç½®ç­–ç•¥ï¼š
```shell
appendfsync always # æ¯æ¬¡æœ‰æ–°å‘½ä»¤è¿½åŠ åˆ° AOF æ–‡ä»¶æ—¶å°±æ‰§è¡Œä¸€æ¬¡ fsync ï¼Œéå¸¸æ…¢ï¼Œä¹Ÿéå¸¸å®‰å…¨ã€‚
appendfsync everysec # æ¯ç§’ fsync ä¸€æ¬¡ï¼Œè¶³å¤Ÿå¿«ï¼Œå¹¶ä¸”åœ¨æ•…éšœæ—¶åªä¼šä¸¢å¤± 1 ç§’é’Ÿçš„æ•°æ®ã€‚
appendfsync no # ä»ä¸ fsync ï¼Œå°†æ•°æ®äº¤ç»™æ“ä½œç³»ç»Ÿæ¥å¤„ç†ã€‚æ›´å¿«ï¼Œä¹Ÿæ›´ä¸å®‰å…¨çš„é€‰æ‹©ã€‚
```

## fsync 
Linux çš„ glibc æä¾›äº† fsync(int fd)å‡½æ•°å¯ä»¥å°†æŒ‡å®šæ–‡ä»¶çš„å†…å®¹å¼ºåˆ¶ä»å†…æ ¸ç¼“å­˜åˆ·åˆ°ç£ ç›˜ã€‚åªè¦ Redis è¿›ç¨‹å®æ—¶è°ƒç”¨ fsync å‡½æ•°å°±å¯ä»¥ä¿è¯ aof 
æ—¥å¿—ä¸ä¸¢å¤±ã€‚ä½†æ˜¯ fsync æ˜¯ä¸€ä¸ª ç£ç›˜ IO æ“ä½œï¼Œå®ƒå¾ˆæ…¢!å¦‚æœ Redis æ‰§è¡Œä¸€æ¡æŒ‡ä»¤å°±è¦ fsync ä¸€æ¬¡ï¼Œé‚£ä¹ˆ Redis é«˜æ€§èƒ½çš„ åœ°ä½å°±ä¸ä¿äº†ã€‚ æ‰€ä»¥åœ¨
ç”Ÿäº§ç¯å¢ƒçš„æœåŠ¡å™¨ä¸­ï¼ŒRedis é€šå¸¸æ˜¯æ¯éš” 1s å·¦å³æ‰§è¡Œä¸€æ¬¡ fsync æ“ä½œï¼Œå‘¨æœŸ 1s æ˜¯å¯ä»¥é…ç½®çš„ã€‚è¿™æ˜¯åœ¨æ•°æ®å®‰å…¨æ€§å’Œæ€§èƒ½ä¹‹é—´åšäº†ä¸€ä¸ªæŠ˜ä¸­ï¼Œåœ¨ä¿æŒ
é«˜æ€§èƒ½çš„åŒæ—¶ï¼Œå°½å¯èƒ½ ä½¿å¾—æ•°æ®å°‘ä¸¢å¤±ã€‚

redis åœ¨ä¸šåŠ¡é•¿æœŸè¿è¡ŒæœŸé—´ï¼ŒAOFçš„æ—¥å¿—è‚¯å®šä¼šå˜å¾—å¾ˆé•¿å¾ˆé•¿ğŸ¤®ã€‚å¦‚æœå®ä¾‹å®•æœºï¼Œé‚£ä¹ˆä½¿ç”¨ AOF æ¢å¤çš„æ—¶å€™ï¼Œä¼šå¯¼è‡´ Redis é•¿æ—¶é—´æ— æ³•å¯¹å¤–æä¾›æœåŠ¡ï¼Œè¿™æ˜¾ç„¶
æ˜¯ä¸èƒ½å®¹å¿çš„ã€‚æ‰€ä»¥éœ€è¦å¯¹ AOF è¿›è¡Œç˜¦èº«ã€‚

### AOF æ—¥å¿—ç˜¦èº«
Redis æä¾›äº† bgrewriteaof æŒ‡ä»¤ç”¨äºå¯¹ AOF æ—¥å¿—è¿›è¡Œç˜¦èº«ã€‚å…¶åŸç†å°±æ˜¯å¼€è¾Ÿä¸€ä¸ªå­è¿›ç¨‹å¯¹å†…å­˜è¿›è¡Œéå†è½¬æ¢æˆä¸€ç³»åˆ— Redis çš„æ“ä½œæŒ‡ä»¤ï¼Œ
åºåˆ—åŒ–åˆ°ä¸€ä¸ªæ–°çš„ AOF æ—¥å¿—æ–‡ä»¶ä¸­ã€‚åšæ³•å°±æ˜¯å»æ‰ç›¸åŒé”®å€¼æ— ç”¨çš„æŒ‡ä»¤ï¼Œåªä¿æŒå¯¹è¯¥ key æ“ä½œçš„æœ€æ–°æŒ‡ä»¤ã€‚

## å°ç»“
1. å¿«ç…§ï¼šå¿«ç…§æ˜¯é€šè¿‡å¼€å¯å­è¿›ç¨‹çš„æ–¹å¼è¿›è¡Œçš„ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ¯”è¾ƒè€—èµ„æºçš„æ“ä½œï¼Œéå†æ•´ä¸ªå†…å­˜ï¼Œå¤§å—å†™ç£ç›˜ä¼šåŠ é‡ç³»ç»Ÿè´Ÿè½½ï¼›
2. AOFï¼šfsync æ˜¯ä¸€ä¸ªè€—æ—¶çš„ IO æ“ä½œï¼Œå®ƒä¼šé™ä½ Redis æ€§èƒ½ï¼ŒåŒæ—¶ä¹Ÿä¼šå¢åŠ ç³»ç»Ÿ IO è´Ÿæ‹…ï¼›

æ‰€ä»¥é€šå¸¸ Redis çš„ä¸»èŠ‚ç‚¹æ˜¯ä¸ä¼šè¿›è¡ŒæŒä¹…åŒ–æ“ä½œï¼ŒæŒä¹…åŒ–æ“ä½œä¸»è¦åœ¨ä»èŠ‚ç‚¹è¿›è¡Œã€‚ä»èŠ‚ ç‚¹æ˜¯å¤‡ä»½èŠ‚ç‚¹ï¼Œæ²¡æœ‰æ¥è‡ªå®¢æˆ·ç«¯è¯·æ±‚çš„å‹åŠ›ï¼Œå®ƒçš„æ“ä½œç³»ç»Ÿèµ„æº
å¾€å¾€æ¯”è¾ƒå……æ²›ã€‚

## Redis 4.0 æ··åˆæŒä¹…åŒ–
ä¸Šé¢æåˆ°è¿‡ï¼ŒRDB å®¹æ˜“ä¸¢å¤±å¤§é‡æ•°æ®ï¼Œä¸€èˆ¬ä½¿ç”¨ aof æ¢å¤ï¼Œä½†æ˜¯ aof æ¢å¤æ•°æ®ç›¸æ¯”äº rdb æ¥è¯´è¦æ…¢å¾ˆå¤šï¼Œåœ¨ redis å®ä¾‹è¾ƒå¤§çš„æƒ…å†µä¸‹ï¼Œå¯åŠ¨å¾ˆæ…¢ã€‚ä¸ºäº†
è§£å†³è¿™æ ·çš„é—®é¢˜ï¼ŒRedis 4.0 å¸¦æ¥äº†ä¸€ä¸ªæ–°çš„æŒä¹…åŒ–é€‰é¡¹â€”â€”æ··åˆæŒä¹…åŒ–ã€‚å°† RDB æ–‡ä»¶å’Œå¢é‡çš„ aof æ—¥å¿—æ–‡ä»¶æ”¾åˆ°ä¸€èµ·ã€‚æ³¨æ„è¿™é‡Œçš„ aof æ—¥å¿—ä¸å†æ˜¯å…¨é‡çš„
æ—¥å¿—äº†ï¼Œè€Œæ˜¯è‡ªæŒä¹…åŒ–å¼€å§‹åˆ°æŒä¹…åŒ–ç»“æŸè¿™ä¸€æ®µæ—¶é—´æ—¥å¿—çš„å¢é‡ã€‚

## Redis æ•°æ®å¤‡ä»½ç­–ç•¥
1. å†™crontabå®šæ—¶è°ƒåº¦è„šæœ¬ï¼Œæ¯å°æ—¶éƒ½copyä¸€ä»½rdbæˆ–aofçš„å¤‡ä»½åˆ°ä¸€ä¸ªç›®å½•ä¸­å»ï¼Œä»…ä»…ä¿ç•™æœ€è¿‘48 å°æ—¶çš„å¤‡ä»½
2. æ¯å¤©éƒ½ä¿ç•™ä¸€ä»½å½“æ—¥çš„æ•°æ®å¤‡ä»½åˆ°ä¸€ä¸ªç›®å½•ä¸­å»ï¼Œå¯ä»¥ä¿ç•™æœ€è¿‘1ä¸ªæœˆçš„å¤‡ä»½
3. æ¯æ¬¡copyå¤‡ä»½çš„æ—¶å€™ï¼Œéƒ½æŠŠå¤ªæ—§çš„å¤‡ä»½ç»™åˆ äº†
4. æ¯å¤©æ™šä¸Šå°†å½“å‰æœºå™¨ä¸Šçš„å¤‡ä»½å¤åˆ¶ä¸€ä»½åˆ°å…¶ä»–æœºå™¨ä¸Šï¼Œä»¥é˜²æœºå™¨æŸå

# Redis ä¸»ä»æ¶æ„
## ä¸»ä»é…ç½®
ä¸»èŠ‚ç‚¹é…ç½®ä¿¡æ¯å¦‚ä¸‹ï¼š
```text
# æŒ‡å®šæœ¬æœºé€šè¿‡æœ¬æœºçš„å“ªä¸€ä¸ª ip åœ°å€æ¥æ¥æ”¶å¤–éƒ¨è¯·æ±‚ï¼Œè€Œä¸æ˜¯å…è®¸é‚£ä¸ª ip è®¿é—®
bind 0.0.0.0
# å…³é—­ä¿æŠ¤æ¨¡å¼
protected-mode no
# è®¾ç½® port ç«¯å£
port 6379
# è®¾ç½®åå°è¿è¡Œ
daemonize yes
# ä¿å­˜ redis è¿è¡Œçš„ pid, è¿›ç¨‹ç»“æŸåä¼šè‡ªåŠ¨åˆ é™¤
pidfile /var/run/redis_6379.pid
# ç”Ÿæˆæ—¥å¿—æ–‡ä»¶åç§°
logfile "redis_6379.log"
# æŒ‡å®šç”Ÿæˆå¤‡ä»½æ•°æ®çš„æ–‡ä»¶ç›®å½•
dir /root/Dev_Azh/redis/data/6379
```
ä»èŠ‚ç‚¹é…ç½®å¦‚ä¸‹ï¼š
```text
# æŒ‡å®šæœ¬æœºé€šè¿‡æœ¬æœºçš„å“ªä¸€ä¸ª ip åœ°å€æ¥æ¥æ”¶å¤–éƒ¨è¯·æ±‚ï¼Œè€Œä¸æ˜¯å…è®¸é‚£ä¸ª ip è®¿é—®
bind 0.0.0.0
# å…³é—­ä¿æŠ¤æ¨¡å¼
protected-mode no
# è®¾ç½® port ç«¯å£
port 6380
# è®¾ç½®åå°è¿è¡Œ
daemonize yes
# ä¿å­˜ redis è¿è¡Œçš„ pid, è¿›ç¨‹ç»“æŸåä¼šè‡ªåŠ¨åˆ é™¤
pidfile /var/run/redis_6380.pid
# ç”Ÿæˆæ—¥å¿—æ–‡ä»¶åç§°
logfile "redis_6380.log"
# æŒ‡å®šç”Ÿæˆå¤‡ä»½æ•°æ®çš„æ–‡ä»¶ç›®å½•
dir /root/Dev_Azh/redis/data/6380
# æŒ‡å®šä¸»èŠ‚ç‚¹è¿æ¥ ip
replicaof 10.211.55.3 6379
```

ç¬¬äºŒä¸ªä»èŠ‚ç‚¹é…ç½®å¦‚ä¸‹ï¼š
```text
# æŒ‡å®šæœ¬æœºé€šè¿‡æœ¬æœºçš„å“ªä¸€ä¸ª ip åœ°å€æ¥æ¥æ”¶å¤–éƒ¨è¯·æ±‚ï¼Œè€Œä¸æ˜¯å…è®¸é‚£ä¸ª ip è®¿é—®
bind 0.0.0.0
# å…³é—­ä¿æŠ¤æ¨¡å¼
protected-mode no
# è®¾ç½® port ç«¯å£
port 6381
# è®¾ç½®åå°è¿è¡Œ
daemonize yes
# ä¿å­˜ redis è¿è¡Œçš„ pid, è¿›ç¨‹ç»“æŸåä¼šè‡ªåŠ¨åˆ é™¤
pidfile /var/run/redis_6381.pid
# ç”Ÿæˆæ—¥å¿—æ–‡ä»¶åç§°
logfile "redis_6381.log"
# æŒ‡å®šç”Ÿæˆå¤‡ä»½æ•°æ®çš„æ–‡ä»¶ç›®å½•
dir /root/Dev_Azh/redis/data/6381
# æŒ‡å®šä¸»èŠ‚ç‚¹è¿æ¥ ip
replicaof 10.211.55.3 6379
```
å…³é—­é˜²ç«å¢™
```shell
# æŸ¥çœ‹é˜²ç«å¢™çŠ¶æ€
firewall-cmd --state
# åœæ­¢é˜²ç«å¢™
systemctl stop firewalld.service
# ç¦æ­¢é˜²ç«å¢™å¼€æœºå¯åŠ¨
systemctl disable firewalld.service 
```


å¼€å§‹å¯åŠ¨å®ä¾‹
```shell
# å¯åŠ¨ä¸»èŠ‚ç‚¹å®ä¾‹
redis-server redis_6379.conf 
# æŸ¥çœ‹æœåŠ¡æ˜¯å¦å¯åŠ¨æˆåŠŸ
ps â€ef | grep redis
# ç»“æœï¼š
root      1599     1  0 20:27 ?        00:00:00 redis-server 0.0.0.0:6379

# å¯åŠ¨ä»èŠ‚ç‚¹å®ä¾‹
redis-server redis_6380.conf 
redis-server redis_6381.conf

# åœ¨ä¸»èŠ‚ç‚¹ä¸Šä½¿ç”¨å®¢æˆ·ç«¯è¿æ¥ redisï¼Œå¹¶è®¾ç½®æ•°æ®
redis-cli -p 6379
# è®¾ç½®æ•°æ®
127.0.0.1:6379> set master:10.211.55.3 "master"
# æ­¤æ—¶è¿æ¥ä¸¤ä¸ªä»èŠ‚ç‚¹å®¢æˆ·ç«¯ï¼ŒæŸ¥çœ‹æ•°æ®æ˜¯å¦åŒæ­¥
redis-cli -p 6380
127.0.0.1:6380> keys *
# è¾“å‡ºç»“æœï¼š
1) "master:10.211.55.3"

redis-cli -p 6381
127.0.0.1:6381> keys *
1) "master:10.211.55.3"
```
è‡³æ­¤ä¸»ä»ç»“æ„æ­å»ºæˆåŠŸã€‚


## Reids ä¸»ä»å·¥ä½œåŸç†
ä¸»ä»å¤åˆ¶è¿‡ç¨‹å¤§ä½“å¯ä»¥åˆ†ä¸º3ä¸ªé˜¶æ®µï¼šè¿æ¥å»ºç«‹é˜¶æ®µï¼ˆå³å‡†å¤‡é˜¶æ®µï¼‰ã€æ•°æ®åŒæ­¥é˜¶æ®µã€å‘½ä»¤ä¼ æ’­é˜¶æ®µã€‚

1. è¿æ¥å»ºç«‹é˜¶æ®µï¼š
   1. å…ˆåœ¨ç¼“å­˜ä¸­ä¿å­˜ master èŠ‚ç‚¹ä¿¡æ¯ï¼›æ—¥å¿—ä¿¡æ¯å¦‚ä¸‹ï¼š
   ```shell
   efore turning into a replica, using my master parameters to synthesize a cached master: I may be able to synchronize 
   with the new master with just a partial transfer
   ```
   2. å»ºç«‹ socket é•¿è¿æ¥ï¼›æ—¥å¿—ä¿¡æ¯å¦‚ä¸‹ï¼š
   ```shell
   Connecting to MASTER 10.211.55.3:6379
   MASTER <-> REPLICA sync started
   ```
   3. å‘é€ ping å‘½ä»¤ç¡®è®¤ä¸»æœºç½‘ç»œç•…é€šï¼›
   ```shell
   Master replied to PING, replication can continue...
   ```
2. æ•°æ®åŒæ­¥é˜¶æ®µ:
   1. ä»èŠ‚ç‚¹å¯åŠ¨ï¼Œæ€»ä¼šå‘ master å‘é€ä¸€ä¸ª psync(2.8ä»¥å‰å‘é€ sync å‘½ä»¤) å‘½ä»¤åˆ° master è¯·æ±‚å¤åˆ¶æ•°æ®ï¼›
   2. ä¸»èŠ‚ç‚¹æ”¶åˆ° psync å‘½ä»¤ä¼šåœ¨åå°è¿›è¡Œæ•°æ®æŒä¹…åŒ–é€šè¿‡bgsaveç”Ÿæˆæœ€æ–°çš„rdbå¿«ç…§æ–‡ä»¶, æŒä¹…åŒ–æœŸé—´ä»ç„¶ä¼šæ¥æ”¶å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼›
   3. åœ¨æŒä¹…åŒ–æœŸé—´ï¼Œmasterä¼šå°†æ¥æ”¶åˆ°å¯èƒ½ä¿®æ”¹æ•°æ®é›†çš„å‘½ä»¤ç¼“å­˜åˆ°å†…å­˜ä¸­ï¼›
   4. master æŒä¹…åŒ–å®Œæˆåï¼Œä¼šå°† rdb æ–‡ä»¶æ•°æ®é›†å‘ç»™ slave èŠ‚ç‚¹ï¼Œslave ä¼šå…ˆå°†è¿™äº›æ•°æ®ç”Ÿæˆ rdb æ–‡ä»¶ï¼Œç„¶åå†åŠ è½½åˆ°å†…å­˜ä¸­ï¼›
   5. æ¥ç€masterä¼šå°†ä¹‹å‰åŠ è½½åˆ°ç¼“å­˜ä¸­çš„å‘½ä»¤å‘é€ç»™ slave
3. å‘½ä»¤ä¼ æ’­é˜¶æ®µï¼š
   1. æ•°æ®åŒæ­¥é˜¶æ®µå®Œæˆåï¼Œä¸»ä»èŠ‚ç‚¹è¿›å…¥å‘½ä»¤ä¼ æ’­é˜¶æ®µï¼›åœ¨è¿™ä¸ªé˜¶æ®µä¸»èŠ‚ç‚¹å°†è‡ªå·±æ‰§è¡Œçš„å†™å‘½ä»¤å‘é€ç»™ä»èŠ‚ç‚¹ï¼Œä»èŠ‚ç‚¹æ¥æ”¶å‘½ä»¤å¹¶æ‰§è¡Œï¼Œä»è€Œä¿è¯ä¸»ä»èŠ‚ç‚¹æ•°æ®çš„ä¸€è‡´æ€§ã€‚
      
æ³¨æ„ï¼šå½“masterä¸slaveä¹‹é—´çš„è¿æ¥ç”±äºæŸäº›åŸå› è€Œæ–­å¼€æ—¶ï¼Œslaveèƒ½å¤Ÿè‡ªåŠ¨é‡è¿Masterï¼Œå¦‚æœmasteræ”¶åˆ°äº†å¤š ä¸ªslaveå¹¶å‘è¿æ¥è¯·æ±‚ï¼Œå®ƒåªä¼šè¿›è¡Œä¸€
æ¬¡æŒä¹…åŒ–ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªè¿æ¥ä¸€æ¬¡ï¼Œç„¶åå†æŠŠè¿™ä¸€ä»½æŒä¹…åŒ–çš„æ•°æ®å‘é€ ç»™å¤šä¸ªå¹¶å‘è¿æ¥çš„slaveã€‚

ä¸»ä»åŒæ­¥åŸç†å›¾(å…¨é‡æ•°æ®å¤åˆ¶)ï¼š
![](../photo/1.ä¸»ä»åŸç†å›¾.png)

### æ•°æ®éƒ¨åˆ†å¤åˆ¶
ä»èŠ‚ç‚¹æ–­å¼€ä¸ä¸»èŠ‚ç‚¹çš„è¿æ¥ï¼Œå†æ¬¡è¿æ¥çš„æ—¶å€™ï¼Œä¸€èˆ¬éƒ½ä¼šå¯¹æ•°æ®è¿›è¡Œå…¨é‡å¤åˆ¶ã€‚ä»redis2.8å¼€å§‹ï¼Œmasterå’Œå®ƒæ‰€æœ‰çš„ slaveéƒ½ç»´æŠ¤äº†å¤åˆ¶çš„æ•°æ®ä¸‹æ ‡
offsetå’Œmasterçš„è¿›ç¨‹idï¼Œå› æ­¤ï¼Œå½“ç½‘ç»œè¿æ¥æ–­å¼€åï¼Œslaveä¼šè¯·æ±‚master ç»§ç»­è¿›è¡Œæœªå®Œæˆçš„å¤åˆ¶ï¼Œä»æ‰€è®°å½•çš„æ•°æ®ä¸‹æ ‡å¼€å§‹ã€‚å¦‚æœmasterè¿›ç¨‹idå˜åŒ–äº†ï¼Œ
æˆ–è€…ä»èŠ‚ç‚¹æ•°æ®ä¸‹æ ‡ offset å¤ªæ—§ï¼Œå·²ç»ä¸åœ¨masterçš„ç¼“å­˜é˜Ÿåˆ—é‡Œäº†ï¼Œé‚£ä¹ˆå°†ä¼šè¿›è¡Œä¸€æ¬¡å…¨é‡æ•°æ®çš„å¤åˆ¶ã€‚è¿™ç§æœºåˆ¶å°±å«**æ–­ç‚¹ç»­ä¼ **

å¦‚å›¾æ‰€ç¤ºï¼š
![](../photo/2.ä¸»ä»å¤åˆ¶-æ–­ç‚¹ç»­ä¼ .png)
æ³¨æ„ï¼šå¦‚æœæœ‰å¾ˆå¤šä»èŠ‚ç‚¹ï¼Œä¸ºäº†ç¼“è§£ä¸»ä»å¤åˆ¶é£æš´(å¤šä¸ªä»èŠ‚ç‚¹åŒæ—¶å¤åˆ¶ä¸»èŠ‚ç‚¹å¯¼è‡´ä¸»èŠ‚ç‚¹å‹åŠ›è¿‡å¤§)ï¼Œå¯ä»¥åšå¦‚ä¸‹æ¶æ„ï¼Œè®©éƒ¨åˆ†ä»èŠ‚ç‚¹ä¸ä»èŠ‚ç‚¹(ä¸ä¸»èŠ‚ç‚¹åŒæ­¥)
åŒæ­¥æ•°æ®ã€‚

# Jedis è¿æ¥ä»£ç å®ä¾‹
å¼•å…¥ç›¸å…³ä¾èµ–
```xml
   <dependency>
      <groupId>redis.clients</groupId>
      <artifactId>jedis</artifactId>
      <version>2.9.0</version>
   </dependency>
```

ç¨‹åº demo
```java
public class JedisDemo {
    public static void main(String[] args) throws IOException {
        JedisPoolConfig jedisPoolConfig = new JedisPoolConfig();
        jedisPoolConfig.setMaxTotal(20);
        jedisPoolConfig.setMaxIdle(10);
        jedisPoolConfig.setMinIdle(5);

        // timeoutï¼Œè¿™é‡Œæ—¢æ˜¯è¿æ¥è¶…æ—¶åˆæ˜¯è¯»å†™è¶…æ—¶ï¼Œä»Jedis 2.8å¼€å§‹æœ‰åŒºåˆ†connectionTimeoutå’ŒsoTimeo tçš„æ„é€ å‡½æ•°
        JedisPool jedisPool = new JedisPool(jedisPoolConfig, "10.211.55.3", 6379, 3000, null);
        Jedis jedis = null;
        
        try{
            //ä»redisè¿æ¥æ± é‡Œæ‹¿å‡ºä¸€ä¸ªè¿æ¥æ‰§è¡Œå‘½ä»¤
            jedis = jedisPool.getResource();
            System.out.println(jedis.set("single", "zhuge"));
            System.out.println(jedis.get("single"));
            //ç®¡é“ç¤ºä¾‹
            //ç®¡é“çš„å‘½ä»¤æ‰§è¡Œæ–¹å¼:cat redis.txt | redisâ€cli â€h 127.0.0.1 â€a password â€ p 6379 â€â€pipe
            /*Pipeline pl = jedis.pipelined();
            for(inti=0;i<10;i++){
                pl.incr("pipelineKey");
                pl.set("zhuge" + i, "zhuge");
            }
             */
            //luaè„šæœ¬æ¨¡æ‹Ÿä¸€ä¸ªå•†å“å‡åº“å­˜çš„åŸå­æ“ä½œ
            //luaè„šæœ¬å‘½ä»¤æ‰§è¡Œæ–¹å¼:redisâ€cli â€â€eval /tmp/test.lua , 10
            /*jedis.set("product_count_10016", "15"); //åˆå§‹åŒ–å•†å“10016çš„åº“å­˜*/
            String script = " local count = redis.call('get', KEYS[1]) " + " local a = tonumber(count) " +
                    " local b = tonumber(ARGV[1]) " + "ifa>=bthen" + " redis.call('set', KEYS[1], aâ€b) " +
                    "end" + " return 0 ";
            Object obj = jedis.eval(script, Arrays.asList("product_count_10016"), Arrays.asList("10"));
            System.out.println(obj);
        }catch (Exception e){
            //æ³¨æ„è¿™é‡Œä¸æ˜¯å…³é—­è¿æ¥ï¼Œåœ¨JedisPoolæ¨¡å¼ä¸‹ï¼ŒJedisä¼šè¢«å½’è¿˜ç»™èµ„æºæ± ã€‚
            if (jedis != null){
                jedis.close();
            }
        }
    }
}
```
# ç®¡é“(Pipeline)
å®¢æˆ·ç«¯å¯ä»¥ä¸€æ¬¡æ€§å‘é€å¤šä¸ªè¯·æ±‚è€Œä¸ç”¨ç­‰å¾…æœåŠ¡å™¨çš„å“åº”ï¼Œå¾…æ‰€æœ‰å‘½ä»¤éƒ½å‘é€å®Œåå†ä¸€æ¬¡æ€§è¯»å–æœåŠ¡çš„å“åº”ï¼Œè¿™æ ·å¯ä»¥æå¤§çš„é™ä½å¤šæ¡å‘½ä»¤æ‰§è¡Œçš„ç½‘ç»œä¼ è¾“
å¼€é”€ï¼Œç®¡é“æ‰§è¡Œå¤šæ¡å‘½ä»¤çš„ç½‘ç»œå¼€é”€å®é™…ä¸Šåªç›¸å½“äºä¸€æ¬¡å‘½ä»¤æ‰§è¡Œçš„ç½‘ç»œå¼€é”€ã€‚éœ€è¦æ³¨æ„åˆ°æ˜¯ç”¨pipelineæ–¹å¼æ‰“åŒ…å‘½ä»¤å‘é€ï¼Œrediså¿…é¡»åœ¨å¤„ç†å®Œæ‰€æœ‰å‘½ä»¤
å‰å…ˆç¼“å­˜èµ·æ‰€æœ‰å‘½ä»¤çš„å¤„ç†ç»“æœã€‚æ‰“åŒ…çš„å‘½ä»¤è¶Šå¤šï¼Œç¼“å­˜æ¶ˆè€—å†…å­˜ä¹Ÿè¶Šå¤šã€‚æ‰€ä»¥å¹¶ä¸æ˜¯æ‰“åŒ…çš„å‘½ä»¤è¶Šå¤šè¶Šå¥½ã€‚pipelineä¸­å‘é€çš„æ¯ä¸ªcommandéƒ½ä¼šè¢«
serverç«‹å³æ‰§è¡Œï¼Œå¦‚æœæ‰§è¡Œå¤±è´¥ï¼Œå°†ä¼šåœ¨æ­¤åçš„å“åº”ä¸­å¾—åˆ°ä¿¡æ¯;ä¹Ÿå°±æ˜¯pipelineå¹¶ä¸æ˜¯è¡¨è¾¾â€œæ‰€æœ‰commandéƒ½ä¸€èµ·æˆåŠŸâ€çš„è¯­ä¹‰ï¼Œç®¡é“ä¸­å‰é¢å‘½ä»¤å¤±è´¥ï¼Œ
åé¢å‘½ä»¤ä¸ä¼šæœ‰å½±å“ï¼Œç»§ç»­æ‰§è¡Œã€‚

```java
package com.anzhi.masterslavejedis;

public class JedisMasterSlaveDemo {
    public static void main(String[] args) throws IOException {
        JedisPoolConfig jedisPoolConfig = new JedisPoolConfig();
        jedisPoolConfig.setMaxTotal(20);
        jedisPoolConfig.setMaxIdle(10);
        jedisPoolConfig.setMinIdle(5);

        // timeoutï¼Œè¿™é‡Œæ—¢æ˜¯è¿æ¥è¶…æ—¶åˆæ˜¯è¯»å†™è¶…æ—¶ï¼Œä»Jedis 2.8å¼€å§‹æœ‰åŒºåˆ†connectionTimeoutå’ŒsoTimeo tçš„æ„é€ å‡½æ•°
        JedisPool jedisPool = new JedisPool(jedisPoolConfig, "10.211.55.3", 6379, 3000, null);
        Jedis jedis = null;
        
        try{
            //ä»redisè¿æ¥æ± é‡Œæ‹¿å‡ºä¸€ä¸ªè¿æ¥æ‰§è¡Œå‘½ä»¤
            jedis = jedisPool.getResource();
            System.out.println(jedis.set("single", "zhuge"));
            System.out.println(jedis.get("single"));
            //ç®¡é“ç¤ºä¾‹
            //ç®¡é“çš„å‘½ä»¤æ‰§è¡Œæ–¹å¼:cat redis.txt | redisâ€cli â€h 127.0.0.1 â€a password â€ p 6379 â€â€pipe
            Pipeline pl = jedis.pipelined();
            for(int i=0;i<10;i++){
                pl.incr("pipelineKey");
                pl.set("zhangsan" + i, "zhuge");
                // æ¨¡æ‹Ÿç®¡é“æŠ¥é”™
                pl.setbit("zhangsan", -1, true);
            }
            List<Object> results=pl.syncAndReturnAll();
            System.out.println(results);
        }catch (Exception e){
            //æ³¨æ„è¿™é‡Œä¸æ˜¯å…³é—­è¿æ¥ï¼Œåœ¨JedisPoolæ¨¡å¼ä¸‹ï¼ŒJedisä¼šè¢«å½’è¿˜ç»™èµ„æºæ± ã€‚
            if (jedis != null){
                jedis.close();
            }
        }
    }
}
```
Redis 2.6 æ¨å‡ºäº†è„šæœ¬åŠŸèƒ½ï¼Œå…è®¸å¼€å‘è€…ä½¿ç”¨Luaè¯­è¨€ç¼–å†™è„šæœ¬ä¼ åˆ°Redisä¸­æ‰§è¡Œã€‚ä½¿ç”¨è„šæœ¬çš„å¥½å¤„å¦‚ä¸‹ï¼š
1. **å‡å°‘ç½‘ç»œå¼€é”€**ï¼šæœ¬æ¥5æ¬¡ç½‘ç»œè¯·æ±‚çš„æ“ä½œï¼Œå¯ä»¥ç”¨ä¸€ä¸ªè¯·æ±‚å®Œæˆï¼ŒåŸå…ˆ5æ¬¡è¯·æ±‚çš„é€»è¾‘æ”¾åœ¨redisæœåŠ¡å™¨ ä¸Šå®Œæˆã€‚ä½¿ç”¨è„šæœ¬ï¼Œå‡å°‘äº†ç½‘ç»œå¾€è¿”æ—¶å»¶ã€‚è¿™ç‚¹è·Ÿç®¡é“ç±»ä¼¼ã€‚
2. **åŸå­æ“ä½œ**ï¼šRedisä¼šå°†æ•´ä¸ªè„šæœ¬ä½œä¸ºä¸€ä¸ªæ•´ä½“æ‰§è¡Œï¼Œä¸­é—´ä¸ä¼šè¢«å…¶ä»–å‘½ä»¤æ’å…¥ã€‚ç®¡é“ä¸æ˜¯åŸå­çš„ï¼Œä¸è¿‡ redisçš„æ‰¹é‡æ“ä½œå‘½ä»¤(ç±»ä¼¼mset)æ˜¯åŸå­çš„ã€‚
3. **æ›¿ä»£redisçš„äº‹åŠ¡åŠŸèƒ½**:redisè‡ªå¸¦çš„äº‹åŠ¡åŠŸèƒ½å¾ˆé¸¡è‚‹ï¼Œè€Œredisçš„luaè„šæœ¬å‡ ä¹å®ç°äº†å¸¸è§„çš„äº‹åŠ¡åŠŸèƒ½ï¼Œ å®˜æ–¹æ¨èå¦‚æœè¦ä½¿ç”¨redisçš„äº‹åŠ¡åŠŸèƒ½å¯ä»¥ç”¨redis luaæ›¿ä»£ã€‚

# Redis å“¨å…µé«˜å¯ç”¨æ¶æ„
ä¸»ä»æ¶æ„ä¸€æ—¦ä¸»èŠ‚ç‚¹æŒ‚äº†ï¼Œå°±éœ€è¦äººå·¥å»ç»´æŠ¤ï¼Œè¿™è‚¯å®šæ˜¯æˆ‘ä»¬ä¸èƒ½æ¥å—çš„ã€‚Redis æœ‰ä¸“é—¨çš„ Sentinel ç›‘æ§æœºåˆ¶ã€‚ä¸‹é¢æ¥æ­å»ºä¸€ä¸‹å“¨å…µé›†ç¾¤ã€‚
é…ç½® sentinel.conf æ–‡ä»¶

ä¸»èŠ‚ç‚¹çš„ sentinel é…ç½®
```text
# port ç«¯å£ä¿®æ”¹
port 26379
# è®¾ç½®åå°è¿è¡Œ
daemonize yes
# è®¾ç½®ä¿å­˜ redis-sentinel è¿›ç¨‹idçš„æ–‡ä»¶åç§°
pidfile /var/run/redis-sentinel-26379.pid
# è®¾ç½®ä¿å­˜æ—¥å¿—æ–‡ä»¶çš„åç§°
logfile "redis-sentinel-26379.log"
# è®¾ç½®ä¿å­˜æ•°æ®çš„æ–‡ä»¶ç›®å½•
dir /root/Dev_Azh/redis/data/26379
# è®¾ç½®è¦ç›‘æ§çš„ä¸»èŠ‚ç‚¹
sentinel monitor mymaster 10.211.55.3 6379 2
```

ä»èŠ‚ç‚¹ sentinel çš„é…ç½®
```text
# port ç«¯å£ä¿®æ”¹
port 26380
# è®¾ç½®åå°è¿è¡Œ
daemonize yes
# è®¾ç½®ä¿å­˜ redis-sentinel è¿›ç¨‹idçš„æ–‡ä»¶åç§°
pidfile /var/run/redis-sentinel-26380.pid
# è®¾ç½®ä¿å­˜æ—¥å¿—æ–‡ä»¶çš„åç§°
logfile "redis-sentinel-26380.log"
# è®¾ç½®ä¿å­˜æ•°æ®çš„æ–‡ä»¶ç›®å½•
dir /root/Dev_Azh/redis/data/26380
# è®¾ç½®è¦ç›‘æ§çš„ä¸»èŠ‚ç‚¹
sentinel monitor mymaster 10.211.55.3 6379 2

# port ç«¯å£ä¿®æ”¹
port 26381
# è®¾ç½®åå°è¿è¡Œ
daemonize yes
# è®¾ç½®ä¿å­˜ redis-sentinel è¿›ç¨‹idçš„æ–‡ä»¶åç§°
pidfile /var/run/redis-sentinel-26381.pid
# è®¾ç½®ä¿å­˜æ—¥å¿—æ–‡ä»¶çš„åç§°
logfile "redis-sentinel-26381.log"
# è®¾ç½®ä¿å­˜æ•°æ®çš„æ–‡ä»¶ç›®å½•
dir /root/Dev_Azh/redis/data/26381
# è®¾ç½®è¦ç›‘æ§çš„ä¸»èŠ‚ç‚¹
sentinel monitor mymaster 10.211.55.3 6379 2
```

ä¸Šé¢æˆ‘ä»¬å·²ç»é…ç½®å¥½äº†ä¸»ä»èŠ‚ç‚¹çš„é›†ç¾¤ï¼Œé‚£ä¸ªé…ç½®éƒ½ä¸éœ€è¦æ”¹ã€‚åœ¨å¯åŠ¨ä¸»ä»é›†ç¾¤ä¹‹åï¼Œå†å¯åŠ¨ sentinel ç›‘æ§
```shell
# å¯åŠ¨ä¸»èŠ‚ç‚¹ç›‘æ§
redis-sentinel sentinel_26379.conf
redis-sentinel sentinel_26380.conf 
redis-sentinel sentinel_26381.conf

# æŸ¥çœ‹æ˜¯å¦å¯åŠ¨æˆåŠŸï¼š
ps -ef | grep redis
root      1772     1  0 21:09 ?        00:00:04 redis-sentinel *:26379 [sentinel]
root      1880     1  0 21:27 ?        00:00:00 redis-server 0.0.0.0:6379

# å®¢æˆ·ç«¯è¿æ¥ sentinel æœåŠ¡
redis-cli -p 26379
# ç”¨ info æŸ¥çœ‹ä¿¡æ¯
# Sentinel
sentinel_masters:1
sentinel_tilt:0
sentinel_running_scripts:0
sentinel_scripts_queue_length:0
sentinel_simulate_failure_flags:0
master0:name=mymaster,status=ok,address=10.211.55.4:6380,slaves=2,sentinels=3
```
å¯ä»¥çœ‹åˆ°å½“å‰ä¸»èŠ‚ç‚¹æ˜¯ 10.211.55.4, é‚£ä¹ˆå°†ä¸»èŠ‚ç‚¹æŒ‚æ‰ï¼ŒéªŒè¯æ•…éšœè½¬ç§»ï¼š
```text
# åœ¨ä¸»èŠ‚ç‚¹å¯¹åº”çš„è™šæœºä¸Šå°†redisæœåŠ¡ kill
ps -ef | grep redis
root      1610     1  0 20:28 ?        00:00:06 redis-server 0.0.0.0:6380
root      1768     1  0 21:04 ?        00:00:05 redis-sentinel *:26380 [sentinel]
root      1891  1585  0 21:33 pts/0    00:00:00 grep --color=auto redis

# æ€æ­»è¿›ç¨‹
kill -9 1610

# åœ¨è¯¥ä¸»æœºä¸Šè¿æ¥ sentinel æœåŠ¡
redis-cli -p 26380
# æŸ¥çœ‹ä¸»èŠ‚ç‚¹ä¿¡æ¯
127.0.0.1:26379> info

# Sentinel
sentinel_masters:1
sentinel_tilt:0
sentinel_running_scripts:0
sentinel_scripts_queue_length:0
sentinel_simulate_failure_flags:0
master0:name=mymaster,status=ok,address=10.211.55.3:6379,slaves=2,sentinels=3
```
å¯ä»¥çœ‹åˆ°ä¸»èŠ‚ç‚¹ä» 10.211.55.4 å˜æˆäº† 10.211.55.3 è¿™ä¸ªèŠ‚ç‚¹ã€‚

# ä»£ç éªŒè¯
pom.xml ä¾èµ–
```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <groupId>org.example</groupId>
    <artifactId>redis</artifactId>
    <version>1.0-SNAPSHOT</version>

    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>2.3.1.RELEASE</version>
        <relativePath/> <!-- lookup parent from repository -->
    </parent>

    <properties>
        <maven.compiler.source>8</maven.compiler.source>
        <maven.compiler.target>8</maven.compiler.target>
    </properties>
    
    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-redis</artifactId>
        </dependency>

        <dependency>
            <groupId>org.apache.commons</groupId>
            <artifactId>commons-pool2</artifactId>
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
        
        <dependency>
            <groupId>redis.clients</groupId>
            <artifactId>jedis</artifactId>
            <version>2.9.0</version>
        </dependency>
    </dependencies>

    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
            </plugin>
        </plugins>
    </build>

</project>
```

yaml æ–‡ä»¶é…ç½®
```yaml
server:
  port: 8080
  
spring:
  redis:
    database: 0
    timeout: 3000
    sentinel:
      master: mymaster
      nodes: 10.211.55.3:26379,10.211.55.4:26380,10.211.55.5:26381
    lettuce:
      pool:
        max-idle: 50
        min-idle: 10
        max-active: 100
        max-wait: 1000
```

è¿æ¥redis demo
```java
package com.anzhi.sentineljedis.service;

import redis.clients.jedis.HostAndPort;
import redis.clients.jedis.Jedis;
import redis.clients.jedis.JedisPoolConfig;
import redis.clients.jedis.JedisSentinelPool;

import java.util.HashSet;
import java.util.Set;

public class JedisSentinelDemo {
    public static void main(String[] args) {
        JedisPoolConfig config = new JedisPoolConfig();
        config.setMaxTotal(20);
        config.setMaxIdle(10);
        config.setMinIdle(5);

        String masterName = "mymaster";
        Set<String> sentinels = new HashSet<String>();
        sentinels.add(new HostAndPort("10.211.55.3",26379).toString());
        sentinels.add(new HostAndPort("10.211.55.4",26380).toString());
        sentinels.add(new HostAndPort("10.211.55.5",26381).toString());

        //JedisSentinelPoolå…¶å®æœ¬è´¨è·ŸJedisPoolç±»ä¼¼ï¼Œéƒ½æ˜¯ä¸redisä¸»èŠ‚ç‚¹å»ºç«‹çš„è¿æ¥æ± 
        //JedisSentinelPoolå¹¶ä¸æ˜¯è¯´ä¸sentinelå»ºç«‹çš„è¿æ¥æ± ï¼Œè€Œæ˜¯é€šè¿‡sentinelå‘ç°redisä¸»èŠ‚ç‚¹å¹¶ä¸å…¶å»ºç«‹è¿æ¥
        JedisSentinelPool jedisSentinelPool = new JedisSentinelPool(masterName, sentinels, config, 3000, null);
        Jedis jedis = null;
        try{
            jedis = jedisSentinelPool.getResource();
            System.out.println(jedis.set("sentinel", "masterA"));
            System.out.println(jedis.get("sentinel"));
            System.out.println(jedis.del("sentinel"));
        }catch (Exception e){
            // doNothing
        }finally {
            //æ³¨æ„è¿™é‡Œä¸æ˜¯å…³é—­è¿æ¥ï¼Œåœ¨JedisPoolæ¨¡å¼ä¸‹ï¼ŒJedisä¼šè¢«å½’è¿˜ç»™èµ„æºæ± ã€‚
            if (jedis != null){
                jedis.close();
            }
        }
    }
}
```
Controller å±‚æ¥å£
```java
package com.anzhi.sentineljedis.controller;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.redis.core.StringRedisTemplate;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class SentinelIndexCOntroller {
    private static final Logger logger = LoggerFactory.getLogger(SentinelIndexCOntroller.class);
    @Autowired
    private StringRedisTemplate stringRedisTemplate;

    /**
     * æµ‹è¯•èŠ‚ç‚¹æŒ‚äº†å“¨å…µé‡æ–°é€‰ä¸¾æ–°çš„masterèŠ‚ç‚¹ï¼Œå®¢æˆ·ç«¯æ˜¯å¦èƒ½åŠ¨æ€æ„ŸçŸ¥åˆ°
     *
     * @throws InterruptedException
     */
    @RequestMapping("/test_sentinel")
    public void testSentinel() throws InterruptedException {
        int i = 1;
        while (true){
            try{
                stringRedisTemplate.opsForValue().set("master"+i, i+""); //jedis.set(key,value);
                System.out.println("è®¾ç½®keyï¼š"+ "master" + i);
                Thread.sleep(10000);
                stringRedisTemplate.delete("master" + i);
                i++;
            }catch (Exception e){
                logger.error("é”™è¯¯ï¼š", e);
            }
        }
    }
}
```
è¿™æ®µç¨‹åºä¸»è¦å¹²çš„äº‹å„¿æ˜¯ï¼šå…ˆè®¾ç½®é”®å€¼ï¼Œç„¶åä¼‘çœ 10ï¼Œåœ¨åˆ é™¤ keyã€‚ä¸€ç›´å¾ªç¯

å¯åŠ¨ç±»
```java
package com.anzhi.sentineljedis;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class SentinelApplication {
    public static void main(String[] args) {
        SpringApplication.run(SentinelApplication.class, args);
    }
}
```
ç¨‹åºå¯åŠ¨åï¼Œé€šè¿‡é“¾æ¥ http://localhost:8080/test_sentinel è®¿é—®ã€‚æ­¤æ—¶æ§åˆ¶å°ä¼šè¾“å‡ºï¼š
```text
è®¾ç½®keyï¼šmaster1
è®¾ç½®keyï¼šmaster2
è®¾ç½®keyï¼šmaster3
è®¾ç½®keyï¼šmaster4
è®¾ç½®keyï¼šmaster5
è®¾ç½®keyï¼šmaster6
è®¾ç½®keyï¼šmaster7
è®¾ç½®keyï¼šmaster8
è®¾ç½®keyï¼šmaster9
```
æ¥ä¸‹æ¥æˆ‘ä»¬å…³é—­ä¸»èŠ‚ç‚¹ï¼Œæ­¤æ—¶æ§åˆ¶å°è¾“å‡ºï¼š
```text
2023-03-02 21:44:51.256  INFO 11153 --- [xecutorLoop-1-3] i.l.core.protocol.ConnectionWatchdog     : Reconnecting, last destination was /10.211.55.5:6381
2023-03-02 21:44:51.376  WARN 11153 --- [ioEventLoop-4-4] i.l.core.protocol.ConnectionWatchdog     : Cannot reconnect to [10.211.55.5:6381]: Connection refused: /10.211.55.5:6381
2023-03-02 21:44:57.259  INFO 11153 --- [xecutorLoop-1-9] i.l.core.protocol.ConnectionWatchdog     : Reconnecting, last destination was 10.211.55.5:6381
2023-03-02 21:44:57.365  WARN 11153 --- [oEventLoop-4-10] i.l.core.protocol.ConnectionWatchdog     : Cannot reconnect to [10.211.55.5:6381]: Connection refused: /10.211.55.5:6381
2023-03-02 21:45:03.865 ERROR 11153 --- [nio-8080-exec-1] c.a.s.c.SentinelIndexCOntroller          : é”™è¯¯ï¼š

org.springframework.dao.QueryTimeoutException: Redis command timed out; nested exception is io.lettuce.core.RedisCommandTimeoutException: Command timed out after 3 second(s)
```
å¯ä»¥çœ‹åˆ°ï¼Œä¸»èŠ‚ç‚¹æ•…éšœï¼Œå¯¼è‡´ç¨‹åºå¼‚å¸¸ã€‚åœ¨ç¨‹åºè¿è¡Œäº†ä¸€æ®µæ—¶é—´åï¼Œé‡æ–°è¿æ¥åˆ°äº†ä¸»èŠ‚ç‚¹ï¼š
```text
2023-03-02 21:45:26.460  INFO 11153 --- [xecutorLoop-1-8] i.l.core.protocol.ConnectionWatchdog     : Reconnecting, last destination was 10.211.55.5:6381
2023-03-02 21:45:26.466  INFO 11153 --- [oEventLoop-4-16] i.l.core.protocol.ReconnectionHandler    : Reconnected to 10.211.55.3:6379
è®¾ç½®keyï¼šmaster9
è®¾ç½®keyï¼šmaster10
```
ä½†æ˜¯æ­¤æ—¶ä¸»èŠ‚ç‚¹å·²ç»å‘ç”Ÿäº†å˜åŒ–ï¼Œå˜æˆäº† 10.211.55.3:6379ï¼Œç„¶åç¨‹åºç»§ç»­è¿è¡Œã€‚




